/* 习皇帝 “习泽东”和“洪宪”（袁世凯的帝号） 神明论 帝皇頌 习得梁家书卷 习大 习king 耀眼黄红黄 习下台 习远凸 小学居士 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 野蛮其体魄 袭包皮 主席+终身制 大大招牌 裹嘎举吸钢闸门 坡涛汹涌 主席贺词 袁世凯第二 阿平 喷粪帝 习emperor 共哀宗 崇祯帝 包包侠 学包积极分子 维尼大帝 习尽贫 喜包皮 不知名氏 vop 腊肉馅儿包子 文明其精神 习病法 中国拉清单工作领导小组组长 毛进平 乳制品 疫情蔓延 维尼警察（X） 信女愿一生吃素 赵弹 吸精瓶 天安门合法继承人 习梦撕 狙击手待命 红二代 灭共助推器 厕所革命 独彩者 10号跳跳虎被维尼拉清单 大撒幣 次级乳包 战疫国 习奥塞斯库、齐奥塞斯库 xdd 玉习大帝 戏博士 终身领导人 刁人13 错误执行者 初二圣君 二百五大帝 习匪帝 禁评的理由 专治各种不服 nmslman（习主席） 每日祈翠 习式病毒 字共狗 西朝鲜人民自治岛 金科律玉 习公奭 连专家也为之叹服的电脑天才 习王的田野上 平平 屎侯 现任匪首 朝令夕改 富平学霸刁斤干 武汉委托李克强 民进党 影子末帝 万岁 九大诉求 平话 恩维尔·霍习 孙笑川 洗包皮 迈克尔·索伊 赛禁评 习大帝 梁家河贵族 国王 习大犬 发皇帝梦 刁近猴 九评 灰习牛 习索里尼 维尼熊 包皇 清零宗、清零帝 人民领袖 视频看望 维尼快乐组织（Winnie##Happy##Organization）简称WHO 习言乱语 习近平光辉形象 毛二 习二胖 席近平 维尼熊给跳跳虎黄牌 习厉王 习卒习 重地之战 鞋哥 崇祯 习像章 清单帝 习核心 形式主义防疫 第22条军规 核平全世界 习思想 足球外交 当代秦始皇 御板泽民 shit禁评 ChinaXi 大海掀翻小池塘 太祖兔 普近 庆丰包·勃列日涅夫 冤大头 习梦思 习“甩锅” 劝进 习时代 外交习语 习教父 独裁国贼 闹得欢 皇帝亲临忠诚的武汉 裸宽包子劾心 粪坑兵法 包禁评 习大郎 甩锅侠 东瘟疫之地统治者暨全境守护者 读稿机 扛麦郎 梦帝 人民战争 毛二世 送礼平 号屎洞 儿童习典 通商宽衣 维持会长 习三点 习壳郎 任志强 老歪脖子树 包包大人 戏包皮 习太孑 中国特色射秽煮疫制度 晚共昏君 习低能儿 大国造疫 WHO的君王 维尼带货 Voice##of##Pooh 贬词包用 nmslese##dream 电脑世代586 二百斤 赵付 习大林 倒车 禁评封号 国贼习近平 猪禁评 彭主席（习主席走了太太接班） 尼哥 戴口赵 捐麦子 习躲躲 习达姆 游泳一千米 维尼梗有害 黑白翠 蔡英文最强助选 梁家河 墨索里习 甴近平 撒币宝 中字头组长 Cicada##3301##XD 书单吟诵者 一带一路 糟糕皇帝 包子金刚腿 习正日 近日成 习猪头 XD 动森 “复辟” 刁斤山 东方project 萨格尔王 尊蛤讨包 家业论 习殡法 这个年很静 SB包子 刁二婚 百万雄师事件 阳台上的哨兵 2020全面小康 一天游泳一千米 匪酋习维尼 梦回大清 叩谢习恩 阿道夫-习 習敗北 习宽衣 习Core 习奥塞斯库 刁槑夶尛 平&强 Heil##Xitler 习歪嘴 巴拿马文件 维尼·屎(Winnie##the##Poo) 包经 抗麦套装 习尔布特 北红尾鸲 野兽先辈 羽日帝 习近砰 智商不重要 维尼DISCO 赵家家仆 200吨 毛装 毛泽东2.0 当皇帝的小丑 大锅瞻遗 习张三丰 A##Big##Deal 假.."~bang！卒 “登基” 习二坐船 领袖习澡水 The##Xi##Factor（习近平因素） bingbang帝 习老八 细颈瓶 习三拍 颐使气指 64岁 乳透社##小反旗 宽衣大帝 哲欣 非洲大撒币 野心习 总书记来我家 親自蒞臨 小学博士 不同意的举手##没有##没有 读书单 习兵法 习匪 习屎黄 赵王 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 邪大大 武统时代 人类命运共同体首席架构师 《生物安全法》 法习斯 白猪 动物森友会 习##卡##巴##卡 祈翠語言包 狙击手布阵 V尼哥 习语 动物之森 刁近乎 习流氓 半羽习近平 战“疫”金句 亲自指挥 枪毙名单 秦城监狱 世宗 包大人 韦来书记 感恩教育 截颈平 公车上书 毛魔转世 中国离岸隐匿资产管理工作领导小组组组长 官僚主义 格萨尔 大撒币 学包分子 席子兵法 颐指气使 悉包皮 没有网络安全就没有国家安全 万岁来武汉了 黄俄 恩重如删 习夶 刁大犬 相信有神论的物理学博士 庆丰废物 川普的朋友or敌人 倒车斯基 新影帝 习二蛋 二次袁、袁世凯二世、袁二 人民领袖 毛近平 断崖式下跌 习是春绿 维尼史 细瓶颈 习总输记 追思焦裕禄 支那精神野爹 修宪帝 4中组长 习包子的Fa 习总 独裁者 包子兵法 皇帝亲临忠诚的武汉 夶 冲塔 习皇的新装 包帝巡游 总加速师 役民五术 习梦死 学包率 疯狂宇宙包 习付 花花公子 清华毕业 讨习檄文 坡涛汹涌 习一尊 乳包文化 狙击手待命 庆丰帝的千秋梦 386系统驱动游戏 昆明湖涨潮 冠子兵法 XDD 习澳塞斯库 隔离”的金葫芦 慨撒大帝 彩色熊 习瘟猪 傻大头 包惠帝 刁二将 维尼之声 青年大学包 北京中南海支部书记 蹄防 习背书 大大品牌 习语录 人均接近八千万 习进棺 Mr##Shithole 习禁评 維尼頌 宽衣帝 粪坑先生 央视姓党 中国的新皇帝 习猪席 孢 背书单 日子像蜜甜 刁远山 瘟疫领主习近平 爱新觉罗近平 亲自指挥疫情 基拉大和习近平 嬉包皮 习武帝 拉清单 五毛主席 末代皇帝 习卒 习大乞 维尼连任 Criminal##Xi##"Xitler"##Jinping 卡近菲 近言 “登机”（与登基同音） 扛麦帝 习废帝 腊肉包 习尿瓶 Corona##Xi（习病毒） 小习微信 甴种 习侯 屎進瓶 亲自脱贫 包子宪法 号尿壶公 塔西佗陷阱 你是反贼吗 墙内人 仲夏夜之中国梦 集近闭 支那毒王 食腐虫 20000T麦子 亲自考察 糖尿维尼 人尽皆知的体育迷 洗尽贫 吃赵弹 中国爱非洲 瘟疫降生习近平 岿然不动 十一郎习近平 纳翠党 总书记来过我的家 共哀宗 “无罩”现身 习呆呆 修宪连任 習敗敗 通商宽衣 NMSL 习包皮 倒车帝 普习金 疯狂宇宙 最后领导人 我是一个足球迷 嘻包皮 习博士 毛孙 红旗下的蛋 习家军 习后主 叩谢习恩 中国离岸隐匿资产管理工作领导小组组组长 宰相 疯狂宇宙大帝 习贼 系包皮 近身平A 维尼写史 shuu##kinn##pei 习猪下台 吸包皮 习条英机 包子病毒 不敢高声语 称帝修宪 爱新觉罗·近平 亲自封号 皇帝的新衣 习蛤 总统包子习 shit##hole##bing##fa shit侯 法外狂徒Lucy（德国） 沼气专家 头上三尺有神明 习是春竹 䒒(tiáo)菦(qín)苹(píng) 亲自删评 禁评大帝 头号球迷 “皇帝梦” 坟头蹦迪 习狍 任大炮 不强自息 庆丰称帝 习包子 动物庄园 做N届的主席 维稳警察（O） 退党 武当七侠的政治斗争 修宪 习包子 毛二习 “黄袍加身” 冰棒外交 时间控制 习二卒 习和谐 万岁来武汉 超邓赶毛 习包子 720事件 翡翠娘娘 惜包皮 无限连任 没规划的葬礼 习特勒 习孢子 “梦回大清” 刁斤二 electron8964 中国首席造梦大师 习曱甴 氼兲嫑炛 两会期间+隐瞒 集金币 习奥赛斯库 老街 习习蛤蛤 野兽主席 习犬犬 刁后主 叼斤干 指定接班人 集金pay 親自視頻 赵人13 virus##king 恐惊天上人 Adolf##Xitler 大兔 習大佬 云视察 添宪宝宝 当代秦二世 习二世胡亥 骑巨龙 第一书记王沪宁 祈翠 维尼挂彩 习驴 彩色哥 孤独的毒王 习二二（二零二零年五月二十二日开二会） 那翠化 口罩大会 刁人13 胡志平 世界最强乞丐 十日文革 包子露宪 屎禁评 Chairman##Xi 皇帝梦 十里山路不换肩 口罩外交 CoronaXi 满脸喷粪 */
package com.pcdd.sonovel.action;

import cn.hutool.core.lang.Console;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.handle.SearchResultsHandler;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.model.SearchResult;
import com.pcdd.sonovel.parse.SearchParser;
import com.pcdd.sonovel.util.SourceUtils;
import lombok.AllArgsConstructor;
import lombok.SneakyThrows;

import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * 聚合搜索，从全部书源搜索
 *
 * @author pcdd
 * Created at 2025/3/26
 */
@AllArgsConstructor
public class AggregatedSearchAction {

    public void execute() {
        Scanner sc = Console.scanner();
        Console.print(render("==> 请输入书名或作者（尽量输完整）: ", "green"));
        String kw = sc.nextLine().strip();
        if (kw.isEmpty()) return;

        List<SearchResult> results = getSearchResults(kw);

        SearchParser.printAggregateSearchResult(results);

        new DownloadAction(null).execute(results);
    }

    @SneakyThrows
    public static List<SearchResult> getSearchResults(String kw) {
        List<Source> searchableSources = SourceUtils.getSearchableSources();
        ExecutorService threadPool = Executors.newFixedThreadPool(searchableSources.size());
        List<List<SearchResult>> results = new ArrayList<>();
        CountDownLatch latch = new CountDownLatch(searchableSources.size());
        for (Source source : searchableSources) {
            threadPool.execute(() -> {
                List<SearchResult> res = new SearchParser(source.config).parse(kw);
                Rule rule = source.rule;
                Console.log("==> 书源 {} ({}) 搜索到 {} 条记录", rule.getId(), rule.getName(), res.size());
                results.add(res);
                latch.countDown();
            });
        }
        latch.await();
        List<SearchResult> flatList = new ArrayList<>();
        results.forEach(flatList::addAll);
        return SearchResultsHandler.aggregateSort(flatList, kw);
    }

}