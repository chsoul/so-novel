/* 裸宽包子劾心 “无罩”现身 习总输记 习澳塞斯库 包惠帝 习语录 乳制品 10号跳跳虎被维尼拉清单 习核心 一天游泳一千米 习是春绿 嬉包皮 独彩者 习远凸 不知名氏 人均接近八千万 修宪 禁评的理由 屎禁评 恐惊天上人 总加速师 梦回大清 习公奭 信女愿一生吃素 维尼之声 末代皇帝 哲欣 习是春竹 “登机”（与登基同音） 万岁来武汉 颐使气指 满脸喷粪 nmslman（习主席） 这个年很静 战疫国 阿道夫-习 近身平A 老街 共哀宗 塔西佗陷阱 那翠化 习禁评 当代秦始皇 庆丰包·勃列日涅夫 最后领导人 The##Xi##Factor（习近平因素） 习卒 大大招牌 维尼连任 口罩外交 “复辟” 包包大人 习尽贫 shit禁评 倒车斯基 习背书 背书单 隔离”的金葫芦 Heil##Xitler 腊肉馅儿包子 习二蛋 毛近平 独裁者 人尽皆知的体育迷 中国特色射秽煮疫制度 任大炮 大撒币 通商宽衣 维尼大帝 冰棒外交 灰习牛 维稳警察（O） WHO的君王 祈翠 “黄袍加身” 习后主 爱新觉罗近平 刁大犬 习奥塞斯库 专治各种不服 通商宽衣 扛麦帝 习包子 彩色熊 腊肉包 总书记来我家 夶 十日文革 修宪帝 普近 秦城监狱 天安门合法继承人 修宪连任 习呆呆 孢 影子末帝 口罩大会 平&强 动物庄园 shuu##kinn##pei 黑白翠 卡近菲 赵弹 包子病毒 我是一个足球迷 二百五大帝 刁人13 親自視頻 集近闭 禁评大帝 支那毒王 岿然不动 NMSL 青年大学包 2020全面小康 喷粪帝 大海掀翻小池塘 抗麦套装 习贼 不敢高声语 Mr##Shithole 习教父 邪大大 《生物安全法》 nmslese##dream 习大乞 习卒习 包经 习包皮 皇帝的新衣 嘻包皮 吸包皮 当皇帝的小丑 厕所革命 迈克尔·索伊 Corona##Xi（习病毒） 习驴 国王 毛魔转世 毛二 习二卒 刁二将 人民战争 昆明湖涨潮 习尿瓶 捐麦子 发皇帝梦 现任匪首 颐指气使 耀眼黄红黄 习一尊 当代秦二世 梁家河贵族 赛禁评 习张三丰 彭主席（习主席走了太太接班） 大大品牌 糟糕皇帝 墨索里习 习宽衣 习犬犬 习式病毒 習敗敗 庆丰称帝 悉包皮 学包分子 头上三尺有神明 初二圣君 习狍 黄俄 食腐虫 不同意的举手##没有##没有 清华毕业 中国爱非洲 维尼·屎(Winnie##the##Poo) 习大犬 孤独的毒王 大撒幣 傻大头 包子金刚腿 习二世胡亥 动物森友会 习三拍 席子兵法 送礼平 武当七侠的政治斗争 甩锅侠 阿平 习索里尼 习壳郎 假.."~bang！卒 惜包皮 習敗北 法习斯 恩重如删 习得梁家书卷 云视察 瘟疫领主习近平 习达姆 SB包子 一带一路 尼哥 家业论 戴口赵 毛孙 习奥塞斯库、齐奥塞斯库 添宪宝宝 习大郎 粪坑兵法 习Core 普习金 东方project 中国离岸隐匿资产管理工作领导小组组组长 日子像蜜甜 系包皮 席近平 Voice##of##Pooh 习近砰 学包率 法外狂徒Lucy（德国） 包子宪法 金科律玉 维尼史 习和谐 386系统驱动游戏 细颈瓶 甴种 御板泽民 Cicada##3301##XD 狙击手待命 糖尿维尼 “梦回大清” 习总 习屎黄 习匪帝 羽日帝 主席+终身制 新影帝 蹄防 清单帝 第一书记王沪宁 习时代 习下台 Chairman##Xi 总书记来过我的家 万岁来武汉了 习流氓 virus##king 毛泽东2.0 習大佬 民进党 小习微信 习奥赛斯库 白猪 人民领袖 习条英机 崇祯 狙击手待命 枪毙名单 习病法 格萨尔 毛二习 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 中国拉清单工作领导小组组长 纳翠党 九评 恩维尔·霍习 习包子 蔡英文最强助选 太祖兔 拉清单 习皇帝 习猪席 习二坐船 官僚主义 疯狂宇宙大帝 灭共助推器 宽衣帝 读书单 毛进平 习躲躲 百万雄师事件 习歪嘴 二次袁、袁世凯二世、袁二 形式主义防疫 习皇的新装 刁斤二 冠子兵法 次级乳包 读稿机 刁二婚 终身领导人 指定接班人 叩谢习恩 电脑世代586 相信有神论的物理学博士 屎進瓶 洗尽贫 习付 xdd 近日成 刁近乎 袭包皮 两会期间+隐瞒 超邓赶毛 維尼頌 集金币 叩谢习恩 习兵法 东瘟疫之地统治者暨全境守护者 疯狂宇宙包 崇祯帝 刁近猴 习包子 倒车 叼斤干 野蛮其体魄 没规划的葬礼 帝皇頌 shit侯 神明论 时间控制 胡志平 小学博士 平平 错误执行者 称帝修宪 动物之森 皇帝梦 红二代 撒币宝 爱新觉罗·近平 维持会长 720事件 细瓶颈 习包子的Fa 刁远山 习梦撕 巴拿马文件 习猪下台 习##卡##巴##卡 基拉大和习近平 学包积极分子 清零宗、清零帝 做N届的主席 非洲大撒币 V尼哥 武汉委托李克强 习老八 讨习檄文 親自蒞臨 北红尾鸲 尊蛤讨包 野心习 晚共昏君 氼兲嫑炛 维尼写史 包包侠 洗包皮 二百斤 孙笑川 习家军 慨撒大帝 萨格尔王 亲自指挥疫情 号尿壶公 裹嘎举吸钢闸门 中国的新皇帝 祈翠語言包 “习泽东”和“洪宪”（袁世凯的帝号） 包禁评 electron8964 习二胖 禁评封号 坟头蹦迪 翡翠娘娘 不强自息 4中组长 人类命运共同体首席架构师 包皇 鞋哥 冤大头 梁家河 没有网络安全就没有国家安全 ChinaXi 习大林 刁斤山 疯狂宇宙 维尼挂彩 瘟疫降生习近平 习特勒 䒒(tiáo)菦(qín)苹(píng) 宰相 习近平光辉形象 包子兵法 第22条军规 甴近平 沼气专家 游泳一千米 川普的朋友or敌人 武统时代 大锅瞻遗 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 支那精神野爹 足球外交 屎侯 刁人13 央视姓党 刁槑夶尛 戏包皮 匪酋习维尼 习夶 维尼熊给跳跳虎黄牌 视频看望 乳包文化 老歪脖子树 习厉王 外交习语 世宗 Criminal##Xi##"Xitler"##Jinping 赵付 五毛主席 字共狗 庆丰废物 野兽先辈 XD 习王的田野上 包子露宪 皇帝亲临忠诚的武汉 习猪头 吃赵弹 骑巨龙 半羽习近平 bingbang帝 CoronaXi 毛装 XDD 红旗下的蛋 集金pay “皇帝梦” 任志强 习三点 戏博士 野兽主席 近言 赵家家仆 维尼快乐组织（Winnie##Happy##Organization）简称WHO 毛二世 北京中南海支部书记 习孢子 狙击手布阵 习言乱语 “登基” 闹得欢 习大帝 十一郎习近平 重地之战 九大诉求 习博士 习瘟猪 主席贺词 阳台上的哨兵 喜包皮 亲自删评 习废帝 袁世凯第二 习二二（二零二零年五月二十二日开二会） 粪坑先生 习曱甴 动森 役民五术 大国造疫 中国首席造梦大师 公车上书 感恩教育 习匪 习“甩锅” 人民领袖 战“疫”金句 中字头组长 墙内人 韦来书记 亲自指挥 截颈平 每日祈翠 贬词包用 20000T麦子 花花公子 猪禁评 维尼熊 儿童习典 习蛤 亲自考察 习侯 断崖式下跌 习尔布特 号屎洞 扛麦郎 习殡法 包帝巡游 包大人 连专家也为之叹服的电脑天才 维尼警察（X） 习正日 维尼梗有害 追思焦裕禄 习习蛤蛤 大兔 赵人13 A##Big##Deal 小学居士 宽衣大帝 vop 梦帝 皇帝亲临忠诚的武汉 习梦死 中国离岸隐匿资产管理工作领导小组组组长 习像章 习梦思 你是反贼吗 200吨 总统包子习 64岁 头号球迷 坡涛汹涌 习思想 平话 Adolf##Xitler 朝令夕改 书单吟诵者 玉习大帝 亲自脱贫 吸精瓶 彩色哥 独裁国贼 刁后主 倒车帝 冲塔 共哀宗 赵王 shit##hole##bing##fa 退党 世界最强乞丐 仲夏夜之中国梦 习emperor 习king 习语 十里山路不换肩 习武帝 西朝鲜人民自治岛 维尼DISCO 习大 无限连任 坡涛汹涌 国贼习近平 亲自封号 智商不重要 习进棺 文明其精神 万岁 领袖习澡水 习太孑 庆丰帝的千秋梦 核平全世界 疫情蔓延 富平学霸刁斤干 劝进 乳透社##小反旗 维尼带货 习低能儿 */
package com.pcdd.sonovel.parse;

import cn.hutool.core.util.StrUtil;
import com.pcdd.sonovel.convert.ChineseConverter;
import com.pcdd.sonovel.core.CoverUpdater;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.model.ContentType;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.util.CrawlUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import lombok.SneakyThrows;
import org.jsoup.nodes.Document;

/**
 * @author pcdd
 * Created at 2024/3/17
 */
public class BookParser extends Source {

    public BookParser(AppConfig config) {
        super(config);
    }

    @SneakyThrows
    public Book parse(String url) {
        Rule.Book r = this.rule.getBook();
        Document document = jsoup(url)
                .timeout(r.getTimeout())
                .get();

        String bookName = JsoupUtils.selectAndInvokeJs(document, r.getBookName(), getContentType(r.getBookName()));
        String author = JsoupUtils.selectAndInvokeJs(document, r.getAuthor(), getContentType(r.getAuthor()));
        String intro = StrUtil.cleanBlank(JsoupUtils.selectAndInvokeJs(document, r.getIntro(), getContentType(r.getIntro())));
        String coverUrl = JsoupUtils.selectAndInvokeJs(document, r.getCoverUrl(),
                r.getCoverUrl().startsWith("meta[") ? ContentType.ATTR_CONTENT : ContentType.ATTR_SRC);
        // 以下为非必须属性
        String category = JsoupUtils.selectAndInvokeJs(document, r.getCategory(), getContentType(r.getCategory()));
        String latestChapter = JsoupUtils.selectAndInvokeJs(document, r.getLatestChapter(), getContentType(r.getLatestChapter()));
        String lastUpdateTime = JsoupUtils.selectAndInvokeJs(document, r.getLastUpdateTime(), getContentType(r.getLastUpdateTime()));
        String status = JsoupUtils.selectAndInvokeJs(document, r.getStatus(), getContentType(r.getStatus()));
        String wordCount = JsoupUtils.selectAndInvokeJs(document, r.getWordCount(), getContentType(r.getWordCount()));

        Book book = new Book();
        book.setUrl(url);
        book.setBookName(bookName);
        book.setAuthor(author);
        book.setIntro(intro);
        book.setCoverUrl(CoverUpdater.fetchCover(book, CrawlUtils.normalizeUrl(coverUrl, this.rule.getUrl())));
        book.setCategory(category);
        book.setLatestChapter(latestChapter);
        book.setLastUpdateTime(lastUpdateTime);
        book.setStatus(status);
        book.setWordCount(wordCount);

        return ChineseConverter.convert(book, this.rule.getLanguage(), config.getLanguage());
    }

    private ContentType getContentType(String query) {
        if (StrUtil.isEmpty(query)) {
            return null;
        }
        return query.startsWith("meta[") ? ContentType.ATTR_CONTENT : ContentType.TEXT;
    }

}