/* 中字头组长 扛麦帝 毛近平 蹄防 刁槑夶尛 洗包皮 赵王 现任匪首 SB包子 一天游泳一千米 赵弹 号尿壶公 习曱甴 倒车帝 老歪脖子树 乳包文化 学包积极分子 恩维尔·霍习 十里山路不换肩 川普的朋友or敌人 粪坑先生 总书记来过我的家 親自視頻 屎進瓶 维尼·屎(Winnie##the##Poo) 习躲躲 羽日帝 赵人13 习武帝 亲自考察 小学居士 狙击手布阵 亲自脱贫 两会期间+隐瞒 恐惊天上人 大撒币 讨习檄文 冲塔 A##Big##Deal 超邓赶毛 习壳郎 彭主席（习主席走了太太接班） 皇帝亲临忠诚的武汉 截颈平 崇祯 ChinaXi 倒车 习习蛤蛤 云视察 细颈瓶 法外狂徒Lucy（德国） 習大佬 匪酋习维尼 亲自删评 4中组长 独裁者 shit##hole##bing##fa 刁斤山 甴近平 禁评封号 北京中南海支部书记 食腐虫 动物之森 习卒习 天安门合法继承人 习低能儿 64岁 吃赵弹 闹得欢 红旗下的蛋 国王 尼哥 金科律玉 信女愿一生吃素 二百斤 习大郎 核平全世界 小学博士 习驴 那翠化 习屎黄 包帝巡游 公车上书 习king 习二二（二零二零年五月二十二日开二会） 习式病毒 修宪连任 习进棺 梁家河贵族 习夶 习大乞 皇帝梦 习尽贫 袁世凯第二 包大人 彩色哥 阿平 专治各种不服 庆丰帝的千秋梦 “梦回大清” 386系统驱动游戏 近身平A 坟头蹦迪 悉包皮 东瘟疫之地统治者暨全境守护者 朝令夕改 总加速师 胡志平 刁二婚 墙内人 XDD 你是反贼吗 Heil##Xitler 习下台 Chairman##Xi 习“甩锅” 学包分子 系包皮 任志强 电脑世代586 野兽主席 学包率 维尼史 昆明湖涨潮 武统时代 尊蛤讨包 颐指气使 包禁评 刁远山 东方project 外交习语 蔡英文最强助选 親自蒞臨 疯狂宇宙包 崇祯帝 习时代 宽衣帝 第22条军规 塔西佗陷阱 习远凸 总书记来我家 习大林 人民领袖 亲自指挥 禁评的理由 吸包皮 WHO的君王 习三拍 枪毙名单 哲欣 习侯 时间控制 萨格尔王 玉习大帝 支那精神野爹 九大诉求 习梦思 添宪宝宝 甩锅侠 战疫国 赵付 恩重如删 习近平光辉形象 夶 袭包皮 疯狂宇宙大帝 惜包皮 西朝鲜人民自治岛 维尼快乐组织（Winnie##Happy##Organization）简称WHO 习皇帝 世界最强乞丐 狙击手待命 包经 䒒(tiáo)菦(qín)苹(píng) 包子病毒 宽衣大帝 形式主义防疫 劝进 傻大头 中国离岸隐匿资产管理工作领导小组组组长 维尼写史 红二代 维尼警察（X） 通商宽衣 中国首席造梦大师 氼兲嫑炛 毛泽东2.0 视频看望 扛麦郎 習敗敗 动物森友会 冤大头 武当七侠的政治斗争 习包子 书单吟诵者 CoronaXi 大撒幣 巴拿马文件 习和谐 习奥塞斯库 习尿瓶 细瓶颈 普近 习瘟猪 鞋哥 习Core 戏博士 中国特色射秽煮疫制度 共哀宗 “复辟” 人民领袖 富平学霸刁斤干 瘟疫领主习近平 2020全面小康 习尔布特 坡涛汹涌 甴种 “登机”（与登基同音） 习思想 叩谢习恩 维尼DISCO 足球外交 文明其精神 《生物安全法》 头上三尺有神明 大兔 武汉委托李克强 习近砰 墨索里习 影子末帝 毛二世 无限连任 每日祈翠 黑白翠 初二圣君 毛孙 没规划的葬礼 习歪嘴 追思焦裕禄 习厉王 送礼平 仲夏夜之中国梦 vop 孢 刁大犬 号屎洞 习犬犬 virus##king 人均接近八千万 nmslman（习主席） shit侯 北红尾鸲 维持会长 不知名氏 毛魔转世 疫情蔓延 集金pay 习教父 第一书记王沪宁 V尼哥 人类命运共同体首席架构师 庆丰称帝 支那毒王 主席贺词 万岁 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 主席+终身制 祈翠語言包 习包皮 沼气专家 习达姆 野兽先辈 帝皇頌 感恩教育 央视姓党 爱新觉罗近平 习猪下台 孙笑川 口罩外交 做N届的主席 退党 二百五大帝 包子兵法 包皇 Corona##Xi（习病毒） 这个年很静 毛进平 shit禁评 习言乱语 包惠帝 刁近猴 独彩者 通商宽衣 晚共昏君 裸宽包子劾心 习背书 冠子兵法 习特勒 Criminal##Xi##"Xitler"##Jinping 平话 习呆呆 读书单 儿童习典 包子宪法 习病法 爱新觉罗·近平 习流氓 习公奭 Mr##Shithole 粪坑兵法 Voice##of##Pooh 阿道夫-习 最后领导人 韦来书记 半羽习近平 习后主 维尼大帝 习博士 习老八 没有网络安全就没有国家安全 清单帝 役民五术 贬词包用 慨撒大帝 习付 bingbang帝 清零宗、清零帝 耀眼黄红黄 屎侯 冰棒外交 “登基” 习宽衣 小习微信 读稿机 席近平 习语 修宪帝 拉清单 共哀宗 习孢子 刁人13 灭共助推器 大锅瞻遗 shuu##kinn##pei 习是春竹 坡涛汹涌 家业论 百万雄师事件 亲自指挥疫情 刁后主 疯狂宇宙 撒币宝 习蛤 格萨尔 重地之战 腊肉馅儿包子 集近闭 The##Xi##Factor（习近平因素） 赛禁评 20000T麦子 普习金 习皇的新装 中国的新皇帝 乳透社##小反旗 宰相 习王的田野上 习废帝 白猪 禁评大帝 中国爱非洲 大大招牌 刁近乎 习二坐船 近言 习禁评 维尼梗有害 习猪席 狙击手待命 末代皇帝 庆丰包·勃列日涅夫 刁人13 习澳塞斯库 Cicada##3301##XD 维尼挂彩 五毛主席 10号跳跳虎被维尼拉清单 猪禁评 嘻包皮 叼斤干 包包大人 二次袁、袁世凯二世、袁二 习兵法 维尼熊 习包子 梁家河 当代秦二世 发皇帝梦 民进党 背书单 习张三丰 指定接班人 称帝修宪 终身领导人 万岁来武汉了 字共狗 习二卒 “黄袍加身” 翡翠娘娘 隔离”的金葫芦 毛二习 习大 国贼习近平 习总输记 习索里尼 庆丰废物 喷粪帝 习二胖 梦帝 习太孑 神明论 新影帝 大大品牌 抗麦套装 卡近菲 岿然不动 习得梁家书卷 维稳警察（O） 祈翠 毛二 习三点 世宗 习奥塞斯库、齐奥塞斯库 嬉包皮 习包子的Fa 野心习 集金币 厕所革命 满脸喷粪 动森 十日文革 刁斤二 毛装 习匪 糟糕皇帝 戴口赵 习一尊 “皇帝梦” 黄俄 迈克尔·索伊 断崖式下跌 花花公子 习梦撕 维尼连任 秦城监狱 阳台上的哨兵 大国造疫 当代秦始皇 御板泽民 习总 人民战争 维尼带货 糖尿维尼 习梦死 “无罩”现身 我是一个足球迷 乳制品 太祖兔 习卒 席子兵法 非洲大撒币 Adolf##Xitler 习猪头 相信有神论的物理学博士 连专家也为之叹服的电脑天才 腊肉包 野蛮其体魄 灰习牛 720事件 万岁来武汉 皇帝亲临忠诚的武汉 习像章 战“疫”金句 习二世胡亥 习家军 假.."~bang！卒 头号球迷 刁二将 近日成 习殡法 “习泽东”和“洪宪”（袁世凯的帝号） 梦回大清 习大犬 xdd 习核心 屎禁评 戏包皮 平平 纳翠党 习语录 200吨 不强自息 次级乳包 习大帝 喜包皮 包包侠 官僚主义 任大炮 动物庄园 洗尽贫 瘟疫降生习近平 一带一路 包子露宪 捐麦子 習敗北 习##卡##巴##卡 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 不同意的举手##没有##没有 維尼頌 nmslese##dream 中国拉清单工作领导小组组长 日子像蜜甜 包子金刚腿 骑巨龙 邪大大 习正日 颐使气指 法习斯 人尽皆知的体育迷 基拉大和习近平 当皇帝的小丑 口罩大会 赵家家仆 九评 裹嘎举吸钢闸门 孤独的毒王 习贼 NMSL 领袖习澡水 习奥赛斯库 习狍 错误执行者 倒车斯基 十一郎习近平 游泳一千米 中国离岸隐匿资产管理工作领导小组组组长 平&强 吸精瓶 清华毕业 习包子 习匪帝 习二蛋 叩谢习恩 习emperor 亲自封号 皇帝的新衣 青年大学包 维尼熊给跳跳虎黄牌 XD 智商不重要 习是春绿 electron8964 独裁国贼 老街 不敢高声语 彩色熊 维尼之声 习条英机 大海掀翻小池塘 修宪 总统包子习 */
package com.pcdd.sonovel.parse;

import cn.hutool.core.collection.CollUtil;
import cn.hutool.core.collection.ListUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.lang.ConsoleTable;
import cn.hutool.core.util.ArrayUtil;
import cn.hutool.core.util.ReUtil;
import cn.hutool.core.util.StrUtil;
import cn.hutool.core.util.URLUtil;
import com.pcdd.sonovel.convert.ChineseConverter;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.handle.SearchResultsHandler;
import com.pcdd.sonovel.model.*;
import com.pcdd.sonovel.util.CrawlUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import lombok.SneakyThrows;
import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.util.*;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2024/3/23
 */
public class SearchParser extends Source {

    public static final int TEXT_LIMIT_LENGTH = 30;

    public SearchParser(AppConfig config) {
        super(config);
    }

    public List<SearchResult> parse(String keyword, boolean isSort) {
        return isSort ? SearchResultsHandler.sort(parse(keyword)) : parse(keyword);
    }

    @SneakyThrows
    public List<SearchResult> parse(String keyword) {
        // 模拟搜索请求
        Document document;
        Connection.Response resp;
        Rule.Search r = this.rule.getSearch();

        if (r == null) {
            Console.log("书源 {} 不支持搜索", config.getSourceId());
            return Collections.emptyList();
        }

        try {
            resp = jsoup(r.getUrl().formatted(keyword))
                    .timeout(r.getTimeout())
                    .data(CrawlUtils.buildData(r.getData(), keyword))
                    .cookies(CrawlUtils.buildCookies(r.getCookies()))
                    .execute();
            document = Jsoup.parse(resp.body());
        } catch (Exception e) {
            Console.error(render("书源 {} 搜索解析出错: {}", "red"), this.rule.getId(), e.getMessage());
            return Collections.emptyList();
        }

        List<SearchResult> firstPageResults = getSearchResults(null, resp);
        // 搜索结果无分页
        if (!r.isPagination()) {
            return firstPageResults;
        }

        // 注意，css 或 xpath 的查询结果必须为多个 a 元素，且 1 <= limitPage < searchPages.size()，否则 limitPage 无效
        Elements nextPageUrls = JsoupUtils.select(document, r.getNextPage());
        // 只有一页时，底部可能没有分页菜单
        if (nextPageUrls.isEmpty()) {
            return firstPageResults;
        }
        // 分页搜索结果的 URL，不含首页
        Set<String> urls = new LinkedHashSet<>();
        // 一次性获取分页 URL，不考虑逐个点击下一页的情况
        for (Element e : nextPageUrls) {
            String href = CrawlUtils.normalizeUrl(e.attr("href"), this.rule.getUrl());
            // 中文解码，针对69書吧
            urls.add(URLUtil.decode(href));
        }
        // 使用并行流处理分页 URL
        List<SearchResult> additionalResults = urls.parallelStream()
                .flatMap(url -> getSearchResults(url, null).stream())
                .toList();
        // 合并，不去重（去重用 union）
        List<SearchResult> searchResults = CollUtil.unionAll(firstPageResults, additionalResults);
        // TODO 优化，需要几条获取几条，而不是一次性获取然后截取
        return CollUtil.sub(searchResults, 0, config.getSearchLimit());
    }

    private List<SearchResult> getSearchResults(String url, Connection.Response resp) {
        Rule.Search r = this.rule.getSearch();
        List<SearchResult> list = new ArrayList<>();
        try {
            // 搜索结果页 DOM
            Document document = resp == null
                    ? jsoup(url).timeout(r.getTimeout()).get()
                    : Jsoup.parse(resp.body());
            Elements resultEls = document.select(r.getResult());

            // 部分书源完全匹配时会直接跳转到详情页（搜索结果为空 && 书名不为空），故需要构造搜索结果
            if (resultEls.isEmpty() && !document.select(this.rule.getBook().getBookName()).isEmpty()) {
                String bookUrl = resp.url().toString();
                BookParser bookParser = new BookParser(config);
                Book book = bookParser.parse(bookUrl);

                if (StrUtil.isBlank(book.getBookName())) {
                    return Collections.emptyList();
                }

                SearchResult sr = SearchResult.builder()
                        .sourceId(this.rule.getId())
                        .url(bookUrl)
                        .bookName(book.getBookName())
                        .author(book.getAuthor())
                        .latestChapter(book.getLatestChapter())
                        .lastUpdateTime(book.getLastUpdateTime())
                        .build();
                list.add(ChineseConverter.convert(sr, this.rule.getLanguage(), config.getLanguage()));
                Thread.sleep(CrawlUtils.randomInterval(config));

                return list;
            }

            // 只获取前 N 条搜索记录
            List<Element> limitResultEls = resultEls.stream()
                    .filter(e -> StrUtil.isNotEmpty(JsoupUtils.selectAndInvokeJs(e, r.getBookName())))
                    .limit(config.getSearchLimit())
                    .toList();

            for (Element el : limitResultEls) {
                // jsoup 不支持一次性获取属性的值
                String href = JsoupUtils.selectAndInvokeJs(el, r.getBookName(), ContentType.ATTR_HREF);
                String bookName = JsoupUtils.selectAndInvokeJs(el, r.getBookName());
                // 以下为非必须属性
                String author = JsoupUtils.selectAndInvokeJs(el, r.getAuthor());
                String category = JsoupUtils.selectAndInvokeJs(el, r.getCategory());
                String latestChapter = JsoupUtils.selectAndInvokeJs(el, r.getLatestChapter());
                String lastUpdateTime = JsoupUtils.selectAndInvokeJs(el, r.getLastUpdateTime());
                String status = JsoupUtils.selectAndInvokeJs(el, r.getStatus());
                String wordCount = JsoupUtils.selectAndInvokeJs(el, r.getWordCount());

                if (bookName.isEmpty()) continue;

                SearchResult sr = SearchResult.builder()
                        .sourceId(this.rule.getId())
                        .url(CrawlUtils.normalizeUrl(href, this.rule.getUrl()))
                        .bookName(bookName)
                        .author(author)
                        .category(category)
                        .latestChapter(latestChapter)
                        .lastUpdateTime(lastUpdateTime)
                        .status(status)
                        .wordCount(wordCount)
                        .build();

                list.add(ChineseConverter.convert(sr, this.rule.getLanguage(), config.getLanguage()));
            }
        } catch (Exception e) {
            Console.error(e);
            return Collections.emptyList();
        }

        return list;
    }

    public void printSearchResult(List<SearchResult> results) {
        Rule.Search r = this.rule.getSearch();
        if (r == null || CollUtil.isEmpty(results)) {
            return;
        }

        ConsoleTable consoleTable = ConsoleTable.create();
        for (int i = 1; i <= results.size(); i++) {
            SearchResult sr = results.get(i - 1);
            List<String> cols = ListUtil.toList(String.valueOf(i), sr.getBookName());
            boolean existsAuthor = addColumnIfNotEmpty(cols, r.getAuthor(), sr.getAuthor());
            boolean existsCategory = addColumnIfNotEmpty(cols, r.getCategory(), sr.getCategory());
            boolean existsLatestChapter = addColumnIfNotEmpty(cols, r.getLatestChapter(), StrUtil.subPre(sr.getLatestChapter(), TEXT_LIMIT_LENGTH));
            boolean existsLastUpdateTime = addColumnIfNotEmpty(cols, r.getLastUpdateTime(), ReUtil.replaceAll(sr.getLastUpdateTime(), "\\d{2}:\\d{2}(:\\d{2})?", ""));
            boolean existsStatus = addColumnIfNotEmpty(cols, r.getStatus(), sr.getStatus());
            boolean existsWordCount = addColumnIfNotEmpty(cols, r.getWordCount(), sr.getWordCount());
            // 构造表头
            if (i == 1) {
                // 必定存在的列
                List<String> titles = ListUtil.toList("序号", "书名");
                if (existsAuthor) titles.add("作者");
                if (existsCategory) titles.add("类别");
                if (existsLatestChapter) titles.add("最新章节");
                if (existsLastUpdateTime) titles.add("更新时间");
                if (existsStatus) titles.add("状态");
                if (existsWordCount) titles.add("总字数");
                consoleTable.addHeader(ArrayUtil.toArray(titles, String.class));
            }
            consoleTable.addBody(ArrayUtil.toArray(cols, String.class));
        }

        Console.table(consoleTable);
    }

    // 辅助方法：只有非空的情况下才添加列
    private boolean addColumnIfNotEmpty(List<String> list, String rule, String value) {
        if (StrUtil.isNotEmpty(rule)) {
            list.add(StrUtil.isNotEmpty(value) ? value : "");
            return true;
        }
        return false;
    }

    public static void printAggregateSearchResult(List<SearchResult> results) {
        ConsoleTable consoleTable = ConsoleTable.create().addHeader("序号", "书名", "作者", "最新章节", "最后更新时间", "书源");
        for (int i = 1; i <= results.size(); i++) {
            SearchResult sr = results.get(i - 1);

            if (sr.getLatestChapter() == null) {
                sr.setLatestChapter("/");
            } else {
                sr.setLatestChapter(StrUtil.subPre(sr.getLatestChapter(), TEXT_LIMIT_LENGTH));
            }
            if (sr.getLastUpdateTime() == null) {
                sr.setLastUpdateTime("/");
            }

            consoleTable.addBody(
                    String.valueOf(i),
                    sr.getBookName(),
                    sr.getAuthor(),
                    sr.getLatestChapter(),
                    ReUtil.replaceAll(sr.getLastUpdateTime(), "\\d{2}:\\d{2}(:\\d{2})?", ""),
                    String.valueOf(sr.getSourceId())
            );
        }
        Console.table(consoleTable);
    }

}