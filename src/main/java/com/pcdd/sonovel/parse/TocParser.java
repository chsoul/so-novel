/* 习大 维尼带货 电脑世代586 感恩教育 每日祈翠 人民领袖 宽衣帝 赵付 巴拿马文件 习二坐船 富平学霸刁斤干 习屎黄 习后主 仲夏夜之中国梦 洗包皮 包禁评 冠子兵法 习匪 赛禁评 孙笑川 亲自脱贫 毛二习 习习蛤蛤 人均接近八千万 禁评的理由 屎進瓶 秦城监狱 乳透社##小反旗 习二世胡亥 外交习语 习尔布特 胡志平 耀眼黄红黄 Mr##Shithole 习“甩锅” 厕所革命 维尼写史 动物森友会 共哀宗 专治各种不服 岿然不动 瘟疫降生习近平 习二胖 吃赵弹 200吨 刁斤山 维尼大帝 武当七侠的政治斗争 疯狂宇宙 爱新觉罗·近平 野兽先辈 添宪宝宝 总统包子习 习太孑 梦帝 “登机”（与登基同音） 维尼警察（X） 习得梁家书卷 独裁者 习索里尼 卡近菲 战“疫”金句 裸宽包子劾心 二百五大帝 羽日帝 恩维尔·霍习 亲自考察 红二代 中国的新皇帝 习博士 一天游泳一千米 习条英机 川普的朋友or敌人 习梦思 万岁来武汉 大兔 讨习檄文 叩谢习恩 帝皇頌 西朝鲜人民自治岛 满脸喷粪 毛进平 习核心 非洲大撒币 野兽主席 法外狂徒Lucy（德国） 通商宽衣 戏包皮 普近 维尼挂彩 夶 主席+终身制 疯狂宇宙包 人民战争 狙击手待命 xdd 不同意的举手##没有##没有 乳包文化 冲塔 CoronaXi 习梦撕 席子兵法 支那精神野爹 抗麦套装 猪禁评 习歪嘴 习家军 64岁 疯狂宇宙大帝 崇祯 習敗敗 习流氓 新影帝 2020全面小康 食腐虫 扛麦帝 普习金 断崖式下跌 习尿瓶 V尼哥 习澳塞斯库 哲欣 包包侠 阿平 习大郎 慨撒大帝 北京中南海支部书记 公车上书 叼斤干 称帝修宪 万岁来武汉了 赵王 彭主席（习主席走了太太接班） 不知名氏 没规划的葬礼 腊肉包 习躲躲 甴种 皇帝亲临忠诚的武汉 黄俄 狙击手待命 颐使气指 动森 毛装 习武帝 不强自息 昆明湖涨潮 nmslman（习主席） 北红尾鸲 毛二 习猪席 親自蒞臨 乳制品 XD 恩重如删 习驴 匪酋习维尼 习呆呆 二次袁、袁世凯二世、袁二 纳翠党 这个年很静 习猪下台 清华毕业 万岁 影子末帝 学包分子 役民五术 刁人13 包子病毒 习瘟猪 梁家河贵族 主席贺词 维尼史 天安门合法继承人 Chairman##Xi 惜包皮 悉包皮 WHO的君王 总书记来过我的家 倒车斯基 “皇帝梦” 習敗北 习总输记 近日成 甩锅侠 近言 亲自封号 冰棒外交 刁二将 包子宪法 发皇帝梦 视频看望 刁近乎 皇帝梦 文明其精神 “登基” 国贼习近平 习是春竹 蔡英文最强助选 黑白翠 十里山路不换肩 “习泽东”和“洪宪”（袁世凯的帝号） 袁世凯第二 赵家家仆 野蛮其体魄 蹄防 儿童习典 习下台 习包子 习特勒 平话 坡涛汹涌 20000T麦子 小学博士 大锅瞻遗 习蛤 “无罩”现身 习和谐 Voice##of##Pooh 糟糕皇帝 时间控制 electron8964 无限连任 小学居士 号尿壶公 习张三丰 老歪脖子树 习老八 禁评封号 劝进 䒒(tiáo)菦(qín)苹(píng) 习包子的Fa 任志强 包帝巡游 洗尽贫 不敢高声语 假.."~bang！卒 virus##king 毛魔转世 嬉包皮 包经 孤独的毒王 贬词包用 习远凸 萨格尔王 号屎洞 当皇帝的小丑 武汉委托李克强 你是反贼吗 两会期间+隐瞒 连专家也为之叹服的电脑天才 细颈瓶 Criminal##Xi##"Xitler"##Jinping 二百斤 朝令夕改 捐麦子 中国爱非洲 瘟疫领主习近平 习Core 隔离”的金葫芦 SB包子 中国首席造梦大师 习进棺 祈翠 集金pay 彩色哥 野心习 喜包皮 包包大人 屎侯 修宪帝 习三点 鞋哥 系包皮 庆丰包·勃列日涅夫 红旗下的蛋 重地之战 读书单 习是春绿 撒币宝 独彩者 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 韦来书记 粪坑兵法 迈克尔·索伊 习大乞 毛泽东2.0 包子金刚腿 足球外交 十一郎习近平 习壳郎 刁人13 半羽习近平 头上三尺有神明 NMSL 云视察 冤大头 习像章 习一尊 习言乱语 九大诉求 粪坑先生 退党 九评 智商不重要 习匪帝 叩谢习恩 傻大头 习二二（二零二零年五月二十二日开二会） 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 习正日 国王 習大佬 信女愿一生吃素 东方project 习公奭 习皇帝 平&强 我是一个足球迷 戴口赵 习二卒 中国离岸隐匿资产管理工作领导小组组组长 维尼DISCO 游泳一千米 维尼熊给跳跳虎黄牌 崇祯帝 习卒习 截颈平 shuu##kinn##pei 习##卡##巴##卡 禁评大帝 没有网络安全就没有国家安全 bingbang帝 颐指气使 倒车 裹嘎举吸钢闸门 初二圣君 习背书 百万雄师事件 战疫国 世界最强乞丐 习三拍 细瓶颈 习奥塞斯库 修宪连任 总书记来我家 Corona##Xi（习病毒） 习二蛋 习宽衣 维尼快乐组织（Winnie##Happy##Organization）简称WHO 习尽贫 沼气专家 吸包皮 爱新觉罗近平 坟头蹦迪 大撒幣 民进党 邪大大 720事件 第一书记王沪宁 “梦回大清” 习近平光辉形象 五毛主席 家业论 习废帝 支那毒王 包惠帝 习时代 习猪头 神明论 刁二婚 花花公子 亲自指挥 习近砰 官僚主义 近身平A 墙内人 親自視頻 最后领导人 集近闭 世宗 喷粪帝 核平全世界 金科律玉 刁后主 读稿机 刁近猴 亲自删评 口罩大会 习大犬 习孢子 任大炮 腊肉馅儿包子 “黄袍加身” 习大林 习禁评 XDD 灭共助推器 阿道夫-习 习包皮 当代秦二世 皇帝亲临忠诚的武汉 追思焦裕禄 一带一路 维尼之声 维尼梗有害 清零宗、清零帝 习皇的新装 十日文革 相信有神论的物理学博士 席近平 包子兵法 集金币 现任匪首 字共狗 习式病毒 拉清单 法习斯 基拉大和习近平 骑巨龙 人类命运共同体首席架构师 屎禁评 习梦死 老街 习兵法 nmslese##dream 毛孙 庆丰帝的千秋梦 shit##hole##bing##fa 头号球迷 亲自指挥疫情 习卒 错误执行者 大国造疫 皇帝的新衣 终身领导人 习厉王 习包子 动物庄园 糖尿维尼 做N届的主席 疫情蔓延 习总 Adolf##Xitler 毛二世 人尽皆知的体育迷 闹得欢 中国特色射秽煮疫制度 习思想 央视姓党 背书单 The##Xi##Factor（习近平因素） 人民领袖 总加速师 大大招牌 习king 格萨尔 包子露宪 Heil##Xitler 独裁国贼 中国离岸隐匿资产管理工作领导小组组组长 清单帝 晚共昏君 袭包皮 刁斤二 日子像蜜甜 习语录 维尼连任 祈翠語言包 大海掀翻小池塘 修宪 刁大犬 习大帝 东瘟疫之地统治者暨全境守护者 shit禁评 大撒币 通商宽衣 vop 维尼熊 学包率 习夶 口罩外交 形式主义防疫 梁家河 10号跳跳虎被维尼拉清单 太祖兔 维稳警察（O） 次级乳包 彩色熊 386系统驱动游戏 习包子 維尼頌 动物之森 灰习牛 梦回大清 宽衣大帝 维持会长 习病法 御板泽民 白猪 习王的田野上 “复辟” 习达姆 大大品牌 送礼平 阳台上的哨兵 末代皇帝 包皇 习殡法 Cicada##3301##XD 习犬犬 倒车帝 习语 赵弹 习付 shit侯 习奥塞斯库、齐奥塞斯库 氼兲嫑炛 甴近平 4中组长 习教父 中国拉清单工作领导小组组长 书单吟诵者 习奥赛斯库 尊蛤讨包 孢 共哀宗 扛麦郎 A##Big##Deal 狙击手布阵 超邓赶毛 刁远山 《生物安全法》 青年大学包 中字头组长 习侯 庆丰废物 吸精瓶 习曱甴 习emperor 坡涛汹涌 塔西佗陷阱 习贼 戏博士 ChinaXi 武统时代 庆丰称帝 习狍 墨索里习 学包积极分子 翡翠娘娘 恐惊天上人 嘻包皮 尼哥 习低能儿 平平 宰相 指定接班人 领袖习澡水 毛近平 当代秦始皇 小习微信 第22条军规 赵人13 那翠化 枪毙名单 玉习大帝 刁槑夶尛 维尼·屎(Winnie##the##Poo) 包大人 */
package com.pcdd.sonovel.parse;

import cn.hutool.core.collection.CollUtil;
import cn.hutool.core.lang.Opt;
import cn.hutool.core.lang.Validator;
import cn.hutool.core.util.ReUtil;
import cn.hutool.core.util.StrUtil;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Chapter;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.util.CrawlUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import lombok.SneakyThrows;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;

import static com.pcdd.sonovel.model.ContentType.ATTR_HREF;
import static com.pcdd.sonovel.model.ContentType.ATTR_VALUE;

public class TocParser extends Source {

    public TocParser(AppConfig config) {
        super(config);
    }

    /**
     * 解析全章
     */
    public List<Chapter> parse(String url) {
        return parse(url, 1, Integer.MAX_VALUE);
    }

    /**
     * 解析指定范围章节
     *
     * @param url 详情页
     */
    @SneakyThrows
    public List<Chapter> parse(String url, int start, int end) {
        Rule.Book ruleBook = this.rule.getBook();
        Rule.Toc ruleToc = this.rule.getToc();

        // 目录和详情不在同一页面
        if (StrUtil.isNotEmpty(ruleToc.getUrl())) {
            String id = ReUtil.getGroup1(StrUtil.subBefore(ruleBook.getUrl(), "@js:", false), url);
            url = ruleToc.getUrl().formatted(id);
        }
        // 目录分页 url
        Set<String> urls = CollUtil.newLinkedHashSet(url);
        Document document = jsoup(url)
                .timeout(ruleToc.getTimeout())
                .get();

        if (ruleToc.isPagination()) {
            extractPaginationUrls(urls, document, ruleToc);
        }

        return parseToc(urls, start, end, ruleToc);
    }

    @SneakyThrows
    private void extractPaginationUrls(Set<String> urls, Document document, Rule.Toc r) {
        Elements elements = JsoupUtils.select(document, r.getNextPage());
        // 一次性获取分页 URL（下拉菜单）
        if (CollUtil.isNotEmpty(elements) && elements.hasAttr(ATTR_VALUE.getValue())) {
            List<String> list = elements.eachAttr(ATTR_HREF.getValue()).isEmpty()
                    ? elements.eachAttr(ATTR_VALUE.getValue())
                    : elements.eachAttr(ATTR_HREF.getValue());
            list.forEach(s -> urls.add(CrawlUtils.normalizeUrl(s, this.rule.getUrl())));
            return;
        }
        // 以下代码覆盖率可能为 0，因为分页的目录基本全都是通过下拉菜单一次性获取的
        // 递归获取分页 URL（模拟点击下一页）
        while (true) {
            String nextUrl = Opt.ofNullable(JsoupUtils.selectAndInvokeJs(document, r.getNextPage(), ATTR_HREF))
                    .filter(StrUtil::isNotEmpty)
                    .orElse(JsoupUtils.selectAndInvokeJs(document, r.getNextPage(), ATTR_VALUE));
            if (StrUtil.isEmpty(nextUrl) || !Validator.isUrl(nextUrl)) break;
            nextUrl = CrawlUtils.normalizeUrl(nextUrl, this.rule.getUrl());
            urls.add(nextUrl);
            document = jsoup(nextUrl)
                    .timeout(r.getTimeout())
                    .get();
            Thread.sleep(CrawlUtils.randomInterval(config));
        }
    }

    // TODO 优化，改为多线程
    @SneakyThrows
    private List<Chapter> parseToc(Set<String> urls, int start, int end, Rule.Toc r) {
        List<Chapter> toc = new ArrayList<>();
        boolean isDesc = r.isDesc();
        int orderNumber = 1;
        int offset = r.getOffset() != null ? r.getOffset() : 0;

        for (String s : urls) {
            Document document = jsoup(s)
                    .timeout(r.getTimeout())
                    .get();
            // TODO rule.toc.result 实现 JS 语法，在此调用比 addChapter 性能更好
            List<Element> elements = JsoupUtils.select(document, r.getResult());
            if (offset != 0) {
                elements = adjustElementsByOffset(elements, offset);
            }
            int minIndex = Math.min(end, elements.size());
            if (isDesc) {
                for (int i = minIndex - 1; i >= start - 1; i--) {
                    addChapter(elements.get(i), toc, orderNumber++, r);
                }
            } else {
                for (int i = start - 1; i < minIndex; i++) {
                    addChapter(elements.get(i), toc, orderNumber++, r);
                }
            }
        }

        return CollUtil.distinct(toc, Chapter::getTitle, false);
    }

    private List<Element> adjustElementsByOffset(List<Element> elements, int offset) {
        if (elements.size() < offset) {
            return elements;
        }
        if (offset > 0) {
            return elements.subList(offset, elements.size());
        }
        if (offset < 0) {
            return elements.subList(0, elements.size() + offset);
        }
        return elements;
    }

    private void addChapter(Element el, List<Chapter> toc, int order, Rule.Toc r) {
        String url = JsoupUtils.getStrAndInvokeJs(el, r.getNextPage(), ATTR_HREF);
        toc.add(Chapter.builder()
                .title(el.text())
                .url(CrawlUtils.normalizeUrl(url, this.rule.getUrl()))
                .order(order)
                .build());
    }

}