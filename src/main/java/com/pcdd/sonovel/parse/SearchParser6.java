/* 武汉委托李克强 人民战争 “无罩”现身 包子兵法 维尼熊给跳跳虎黄牌 shit禁评 习尔布特 包子宪法 野兽主席 习老八 疫情蔓延 乳包文化 枪毙名单 鞋哥 御板泽民 甩锅侠 人类命运共同体首席架构师 野蛮其体魄 西朝鲜人民自治岛 习包子 袭包皮 刁斤山 叼斤干 大大品牌 独裁者 乳制品 倒车 疯狂宇宙大帝 习瘟猪 万岁 武当七侠的政治斗争 习尽贫 习兵法 V尼哥 宰相 包子金刚腿 太祖兔 梦帝 习思想 习张三丰 腊肉馅儿包子 大兔 梦回大清 习时代 讨习檄文 洗尽贫 没有网络安全就没有国家安全 墙内人 总书记来过我的家 川普的朋友or敌人 vop 习厉王 捐麦子 习包皮 清单帝 袁世凯第二 追思焦裕禄 纳翠党 帝皇頌 沼气专家 现任匪首 10号跳跳虎被维尼拉清单 习夶 瘟疫降生习近平 花花公子 维尼史 人民领袖 electron8964 云视察 維尼頌 假.."~bang！卒 尼哥 ChinaXi 习一尊 主席贺词 坟头蹦迪 狙击手布阵 头号球迷 惜包皮 习是春竹 赵付 戏博士 游泳一千米 Cicada##3301##XD WHO的君王 倒车斯基 系包皮 一带一路 习语 错误执行者 总加速师 习二坐船 CoronaXi 冰棒外交 万岁来武汉了 毛进平 白猪 口罩外交 维尼带货 皇帝亲临忠诚的武汉 洗包皮 习下台 两会期间+隐瞒 刁远山 禁评大帝 集金pay 糟糕皇帝 习近平光辉形象 习呆呆 “复辟” 叩谢习恩 冲塔 最后领导人 称帝修宪 习语录 东方project 动物森友会 彭主席（习主席走了太太接班） 习王的田野上 修宪 字共狗 屎禁评 这个年很静 祈翠 刁近乎 嘻包皮 刁人13 “梦回大清” 喷粪帝 宽衣大帝 NMSL 仲夏夜之中国梦 读稿机 红二代 亲自指挥疫情 习言乱语 第一书记王沪宁 习卒 青年大学包 习三拍 邪大大 尊蛤讨包 习二蛋 刁二将 中国离岸隐匿资产管理工作领导小组组组长 親自視頻 墨索里习 倒车帝 糖尿维尼 Heil##Xitler 普近 习殡法 终身领导人 学包积极分子 习贼 席近平 习梦思 彩色哥 包包大人 习匪 shuu##kinn##pei 甴近平 连专家也为之叹服的电脑天才 非洲大撒币 坡涛汹涌 毛二 中国的新皇帝 shit##hole##bing##fa 阿平 口罩大会 大撒幣 毛魔转世 习猪下台 头上三尺有神明 习二胖 习皇帝 影子末帝 习皇的新装 习公奭 儿童习典 皇帝亲临忠诚的武汉 习正日 爱新觉罗·近平 庆丰包·勃列日涅夫 总统包子习 刁二婚 维尼大帝 战“疫”金句 支那精神野爹 宽衣帝 平&强 习卒习 赵王 号屎洞 冤大头 毛近平 庆丰称帝 戴口赵 吃赵弹 习曱甴 一天游泳一千米 SB包子 疯狂宇宙 信女愿一生吃素 玉习大帝 “黄袍加身” 禁评的理由 习侯 匪酋习维尼 晚共昏君 习蛤 家业论 智商不重要 修宪帝 形式主义防疫 习梦死 习大林 “习泽东”和“洪宪”（袁世凯的帝号） 习太孑 颐指气使 习孢子 韦来书记 梁家河贵族 习索里尼 恩重如删 半羽习近平 习尿瓶 A##Big##Deal 二百五大帝 习狍 细瓶颈 人民领袖 当代秦始皇 中国拉清单工作领导小组组长 维持会长 习二二（二零二零年五月二十二日开二会） 习包子的Fa Mr##Shithole 习奥赛斯库 亲自脱贫 主席+终身制 卡近菲 习“甩锅” 狙击手待命 裸宽包子劾心 每日祈翠 超邓赶毛 Voice##of##Pooh 720事件 重地之战 习特勒 细颈瓶 近言 不同意的举手##没有##没有 基拉大和习近平 《生物安全法》 赵人13 瘟疫领主习近平 习犬犬 习梦撕 大锅瞻遗 共哀宗 支那毒王 喜包皮 习流氓 皇帝梦 叩谢习恩 羽日帝 庆丰帝的千秋梦 吸精瓶 习博士 公车上书 维尼之声 央视姓党 新影帝 夶 习低能儿 习废帝 “登机”（与登基同音） Adolf##Xitler 维稳警察（O） 书单吟诵者 习包子 次级乳包 维尼熊 日子像蜜甜 习澳塞斯库 黄俄 动物庄园 习二世胡亥 金科律玉 毛装 劝进 共哀宗 厕所革命 氼兲嫑炛 virus##king 维尼快乐组织（Winnie##Happy##Organization）简称WHO 当皇帝的小丑 维尼连任 戏包皮 nmslese##dream 20000T麦子 国贼习近平 格萨尔 末代皇帝 崇祯 塔西佗陷阱 任大炮 习驴 赛禁评 Chairman##Xi 近日成 视频看望 闹得欢 XDD 刁人13 嬉包皮 添宪宝宝 毛二世 民进党 习猪席 百万雄师事件 祈翠語言包 初二圣君 习大郎 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 习宽衣 梁家河 习壳郎 国王 核平全世界 截颈平 甴种 习和谐 役民五术 神明论 感恩教育 学包率 法习斯 黑白翠 皇帝的新衣 刁后主 维尼·屎(Winnie##the##Poo) 习禁评 亲自考察 拉清单 习躲躲 集近闭 维尼警察（X） 崇祯帝 腊肉包 战疫国 通商宽衣 赵弹 送礼平 普习金 bingbang帝 “登基” 中字头组长 猪禁评 包包侠 小学居士 胡志平 时间控制 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 席子兵法 亲自删评 XD 二百斤 清华毕业 电脑世代586 武统时代 独彩者 五毛主席 九评 Corona##Xi（习病毒） 习king 蹄防 习付 包帝巡游 64岁 岿然不动 十里山路不换肩 习背书 坡涛汹涌 近身平A 食腐虫 习奥塞斯库、齐奥塞斯库 shit侯 孢 习包子 孙笑川 nmslman（习主席） 天安门合法继承人 毛泽东2.0 包子露宪 维尼梗有害 贬词包用 颐使气指 不敢高声语 阳台上的哨兵 外交习语 习武帝 刁斤二 習敗北 秦城监狱 文明其精神 东瘟疫之地统治者暨全境守护者 习emperor 习奥塞斯库 不强自息 亲自指挥 习像章 毛二习 冠子兵法 刁槑夶尛 没规划的葬礼 灰习牛 习达姆 总书记来我家 平话 读书单 相信有神论的物理学博士 第22条军规 野兽先辈 老街 学包分子 动森 扛麦郎 親自蒞臨 通商宽衣 习习蛤蛤 当代秦二世 包子病毒 屎進瓶 撒币宝 习后主 裹嘎举吸钢闸门 悉包皮 孤独的毒王 做N届的主席 粪坑先生 十日文革 北红尾鸲 哲欣 世宗 人均接近八千万 包大人 灭共助推器 九大诉求 你是反贼吗 禁评封号 领袖习澡水 清零宗、清零帝 习Core 世界最强乞丐 习歪嘴 習大佬 吸包皮 二次袁、袁世凯二世、袁二 萨格尔王 万岁来武汉 任志强 北京中南海支部书记 彩色熊 中国离岸隐匿资产管理工作领导小组组组长 習敗敗 骑巨龙 包禁评 刁近猴 集金币 小习微信 习是春绿 乳透社##小反旗 傻大头 386系统驱动游戏 庆丰废物 习猪头 那翠化 习大犬 隔离”的金葫芦 习总输记 退党 满脸喷粪 200吨 小学博士 习屎黄 我是一个足球迷 发皇帝梦 中国爱非洲 恩维尔·霍习 修宪连任 足球外交 包皇 习二卒 习进棺 蔡英文最强助选 Criminal##Xi##"Xitler"##Jinping 䒒(tiáo)菦(qín)苹(píng) 朝令夕改 习核心 毛孙 大国造疫 xdd 动物之森 习家军 习##卡##巴##卡 独裁国贼 巴拿马文件 人尽皆知的体育迷 习得梁家书卷 包惠帝 昆明湖涨潮 法外狂徒Lucy（德国） 2020全面小康 指定接班人 4中组长 赵家家仆 屎侯 无限连任 阿道夫-习 恐惊天上人 迈克尔·索伊 官僚主义 大大招牌 习总 习条英机 红旗下的蛋 爱新觉罗近平 习式病毒 耀眼黄红黄 抗麦套装 “皇帝梦” 亲自封号 大海掀翻小池塘 中国特色射秽煮疫制度 习远凸 十一郎习近平 维尼写史 习大帝 习匪帝 号尿壶公 扛麦帝 维尼挂彩 习近砰 平平 翡翠娘娘 维尼DISCO 习病法 习三点 习大 刁大犬 习教父 疯狂宇宙包 大撒币 习大乞 The##Xi##Factor（习近平因素） 慨撒大帝 狙击手待命 不知名氏 中国首席造梦大师 断崖式下跌 富平学霸刁斤干 专治各种不服 野心习 包经 老歪脖子树 背书单 粪坑兵法 */
package com.pcdd.sonovel.parse;

import cn.hutool.core.io.resource.ResourceUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.lang.TypeReference;
import cn.hutool.core.text.UnicodeUtil;
import cn.hutool.core.util.ReUtil;
import cn.hutool.http.HtmlUtil;
import cn.hutool.http.HttpRequest;
import cn.hutool.http.HttpResponse;
import cn.hutool.json.JSONUtil;
import cn.hutool.script.ScriptUtil;
import com.pcdd.sonovel.convert.ChineseConverter;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.handle.SearchResultsHandler;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.ContentType;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.model.SearchResult;
import com.pcdd.sonovel.util.CrawlUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Map;

/**
 * 书源 6 搜索特殊处理
 *
 * @author pcdd
 * Created at 2024/3/23
 */
public class SearchParser6 extends Source {

    public SearchParser6(AppConfig config) {
        super(config);
    }

    public List<SearchResult> parse(String keyword) {
        Rule.Search r = this.rule.getSearch();
        String js = ResourceUtil.readUtf8Str("js/rule-6.js");
        Object key = ScriptUtil.invoke(js, "getParamB", keyword);
        String param = r.getData().formatted(keyword, key.toString());
        Map<String, String> map = JSONUtil.toBean(param, new TypeReference<>() {
        }, true);

        HttpRequest req = HttpRequest
                .get(this.rule.getUrl())
                .timeout(r.getTimeout())
                .header("Referer", r.getUrl())
                .formStr(map);
        if (config.getProxyEnabled() == 1) {
            req.setHttpProxy(config.getProxyHost(), config.getProxyPort());
        }

        try (HttpResponse resp = req.execute()) {
            String body = resp.body();
            String s = UnicodeUtil.toString(body);
            String s2 = HtmlUtil.unescape(s)
                    .replace("\\r", "")
                    .replace("\\n", "")
                    .replace("\\t", "")
                    .replace("\\/", "/")
                    .replace("\\\"", "'");
            String s3 = ReUtil.getGroup0("\\{(.*?)\\}", s2);
            String beginIndex = "\"content\":";
            String html = s3.substring(s3.indexOf(beginIndex) + beginIndex.length(), s3.lastIndexOf("}"));
            return SearchResultsHandler.sort(getSearchResults(Jsoup.parse(html)));

        } catch (Exception e) {
            Console.error(e.getMessage());
            return Collections.emptyList();
        }
    }

    private List<SearchResult> getSearchResults(Document document) {
        Rule.Search r = this.rule.getSearch();
        List<SearchResult> list = new ArrayList<>();
        Elements elements = document.select(r.getResult());

        for (Element element : elements) {
            String href = JsoupUtils.selectAndInvokeJs(element, r.getBookName(), ContentType.ATTR_HREF);
            String bookName = JsoupUtils.selectAndInvokeJs(element, r.getBookName());
            String author = JsoupUtils.selectAndInvokeJs(element, r.getAuthor());

            SearchResult sr = SearchResult.builder()
                    .url(CrawlUtils.normalizeUrl(href, this.rule.getUrl()))
                    .bookName(bookName)
                    .author(author)
                    .build();

            list.add(ChineseConverter.convert(sr, this.rule.getLanguage(), config.getLanguage()));
        }

        return list;
    }

}