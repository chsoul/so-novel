/* 足球外交 shit侯 青年大学包 习皇的新装 皇帝的新衣 中国离岸隐匿资产管理工作领导小组组组长 恩重如删 大锅瞻遗 糖尿维尼 爱新觉罗近平 最后领导人 习正日 习总输记 习禁评 万岁来武汉了 共哀宗 喜包皮 号屎洞 Mr##Shithole 修宪连任 连专家也为之叹服的电脑天才 赵付 习是春绿 主席+终身制 中国首席造梦大师 世宗 中国离岸隐匿资产管理工作领导小组组组长 大撒币 Adolf##Xitler 总书记来我家 刁二婚 傻大头 狙击手待命 现任匪首 猪禁评 戏包皮 叼斤干 刁近乎 动物之森 卡近菲 刁大犬 领袖习澡水 习呆呆 人民领袖 巴拿马文件 百万雄师事件 包禁评 公车上书 独裁者 习屎黄 吃赵弹 这个年很静 习后主 赛禁评 天安门合法继承人 支那精神野爹 家业论 尊蛤讨包 大撒幣 央视姓党 东方project 习远凸 役民五术 读稿机 东瘟疫之地统治者暨全境守护者 刁斤二 习二坐船 川普的朋友or敌人 黑白翠 中国拉清单工作领导小组组长 禁评的理由 甴种 皇帝亲临忠诚的武汉 裹嘎举吸钢闸门 中字头组长 习付 赵王 你是反贼吗 習敗敗 刁远山 习近砰 学包率 XDD 书单吟诵者 一天游泳一千米 “梦回大清” 两会期间+隐瞒 鞋哥 万岁 习二世胡亥 NMSL 韦来书记 洗尽贫 共哀宗 赵人13 学包积极分子 A##Big##Deal 乳透社##小反旗 习习蛤蛤 任大炮 习躲躲 梦回大清 习大帝 错误执行者 小习微信 386系统驱动游戏 文明其精神 Criminal##Xi##"Xitler"##Jinping 那翠化 禁评封号 截颈平 颐使气指 疯狂宇宙包 赵弹 基拉大和习近平 十一郎习近平 包子露宪 独彩者 习殡法 国王 添宪宝宝 哲欣 夶 习尔布特 习病法 习包子的Fa 晚共昏君 金科律玉 习式病毒 九评 信女愿一生吃素 冤大头 不知名氏 习时代 习##卡##巴##卡 游泳一千米 维尼快乐组织（Winnie##Happy##Organization）简称WHO 平话 战疫国 宽衣大帝 满脸喷粪 习教父 习宽衣 毛孙 口罩大会 庆丰称帝 老街 习大林 习包皮 羽日帝 蔡英文最强助选 抗麦套装 習敗北 核平全世界 习包子 小学居士 XD 习二二（二零二零年五月二十二日开二会） 细瓶颈 叩谢习恩 亲自封号 匪酋习维尼 人尽皆知的体育迷 九大诉求 灭共助推器 胡志平 坟头蹦迪 bingbang帝 庆丰包·勃列日涅夫 习背书 梦帝 包经 野心习 隔离”的金葫芦 亲自删评 万岁来武汉 习emperor 花花公子 包包大人 追思焦裕禄 骑巨龙 习公奭 近言 头上三尺有神明 清华毕业 瘟疫降生习近平 屎進瓶 习下台 习卒习 毛二 朝令夕改 视频看望 当代秦始皇 时间控制 64岁 坡涛汹涌 亲自脱贫 习王的田野上 习武帝 习夶 20000T麦子 席近平 二百五大帝 总统包子习 习是春竹 习卒 坡涛汹涌 修宪 十里山路不换肩 维尼写史 维稳警察（O） 御板泽民 不同意的举手##没有##没有 帝皇頌 习猪席 戏博士 电脑世代586 习老八 修宪帝 彩色哥 武统时代 灰习牛 相信有神论的物理学博士 维尼之声 孢 维尼挂彩 五毛主席 毛魔转世 倒车斯基 祈翠 刁人13 人类命运共同体首席架构师 皇帝亲临忠诚的武汉 格萨尔 食腐虫 一带一路 习孢子 细颈瓶 岿然不动 “无罩”现身 惜包皮 维尼警察（X） 包大人 习特勒 北京中南海支部书记 习一尊 黄俄 发皇帝梦 裸宽包子劾心 习和谐 习匪 包子金刚腿 爱新觉罗·近平 背书单 习三点 贬词包用 刁斤山 秦城监狱 喷粪帝 “黄袍加身” “习泽东”和“洪宪”（袁世凯的帝号） 习像章 大海掀翻小池塘 日子像蜜甜 习尽贫 粪坑先生 Cicada##3301##XD 习言乱语 二百斤 彩色熊 习狍 北红尾鸲 感恩教育 virus##king 习三拍 第一书记王沪宁 刁人13 没规划的葬礼 习奥赛斯库 nmslman（习主席） 包皇 宽衣帝 塔西佗陷阱 疯狂宇宙大帝 支那毒王 习“甩锅” 无限连任 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 维尼熊给跳跳虎黄牌 人民战争 普习金 末代皇帝 习包子 官僚主义 习曱甴 云视察 “登基” 没有网络安全就没有国家安全 习总 习大郎 习犬犬 平&强 习二卒 习蛤 洗包皮 玉习大帝 仲夏夜之中国梦 习奥塞斯库、齐奥塞斯库 习二蛋 智商不重要 儿童习典 2020全面小康 习思想 头号球迷 习侯 庆丰帝的千秋梦 半羽习近平 维尼·屎(Winnie##the##Poo) 习近平光辉形象 毛进平 不敢高声语 袁世凯第二 墨索里习 习梦死 翡翠娘娘 系包皮 狙击手待命 Corona##Xi（习病毒） 腊肉馅儿包子 腊肉包 沼气专家 枪毙名单 习流氓 维尼熊 梁家河 习兵法 号尿壶公 冰棒外交 包子病毒 冲塔 习二胖 维尼DISCO 指定接班人 总书记来过我的家 学包分子 甩锅侠 毛泽东2.0 Voice##of##Pooh 撒币宝 人民领袖 屎侯 近日成 做N届的主席 梁家河贵族 红二代 維尼頌 崇祯 世界最强乞丐 维尼连任 Chairman##Xi 疫情蔓延 刁后主 氼兲嫑炛 疯狂宇宙 影子末帝 武汉委托李克强 动森 邪大大 习核心 恩维尔·霍习 口罩外交 维尼大帝 纳翠党 任志强 专治各种不服 习低能儿 阳台上的哨兵 国贼习近平 维尼梗有害 中国的新皇帝 习索里尼 冠子兵法 毛二习 闹得欢 习厉王 习贼 白猪 vop 称帝修宪 孙笑川 习尿瓶 大大招牌 彭主席（习主席走了太太接班） 倒车帝 每日祈翠 shit禁评 集金pay 习猪下台 恐惊天上人 习大犬 野兽主席 平平 200吨 悉包皮 法外狂徒Lucy（德国） 《生物安全法》 断崖式下跌 吸精瓶 亲自考察 习大 迈克尔·索伊 习博士 粪坑兵法 普近 狙击手布阵 Heil##Xitler 720事件 崇祯帝 独裁国贼 electron8964 扛麦郎 习匪帝 習大佬 刁槑夶尛 战“疫”金句 野蛮其体魄 太祖兔 禁评大帝 祈翠語言包 西朝鲜人民自治岛 毛二世 富平学霸刁斤干 次级乳包 终身领导人 外交习语 甴近平 习奥塞斯库 野兽先辈 习梦思 主席贺词 红旗下的蛋 The##Xi##Factor（习近平因素） 维尼史 习家军 习驴 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 4中组长 读书单 习条英机 包帝巡游 皇帝梦 宰相 xdd 包惠帝 习歪嘴 神明论 V尼哥 戴口赵 初二圣君 耀眼黄红黄 第22条军规 屎禁评 SB包子 吸包皮 法习斯 叩谢习恩 糟糕皇帝 萨格尔王 我是一个足球迷 超邓赶毛 习语录 习包子 阿道夫-习 亲自指挥疫情 通商宽衣 习得梁家书卷 非洲大撒币 嬉包皮 习king 习瘟猪 乳制品 习猪头 阿平 习语 大国造疫 “皇帝梦” 亲自指挥 䒒(tiáo)菦(qín)苹(píng) 维持会长 蹄防 厕所革命 中国特色射秽煮疫制度 WHO的君王 孤独的毒王 二次袁、袁世凯二世、袁二 字共狗 形式主义防疫 动物庄园 shuu##kinn##pei 习澳塞斯库 毛近平 赵家家仆 尼哥 动物森友会 刁二将 刁近猴 包包侠 习皇帝 十日文革 通商宽衣 墙内人 瘟疫领主习近平 shit##hole##bing##fa 假.."~bang！卒 颐指气使 倒车 昆明湖涨潮 大大品牌 习进棺 武当七侠的政治斗争 不强自息 当代秦二世 嘻包皮 习达姆 袭包皮 习废帝 集金币 老歪脖子树 乳包文化 重地之战 人均接近八千万 中国爱非洲 集近闭 大兔 清零宗、清零帝 维尼带货 ChinaXi 清单帝 毛装 庆丰废物 “复辟” 席子兵法 小学博士 习张三丰 包子宪法 親自蒞臨 扛麦帝 “登机”（与登基同音） CoronaXi 讨习檄文 包子兵法 親自視頻 近身平A 民进党 新影帝 习太孑 习Core 送礼平 习大乞 捐麦子 退党 拉清单 习壳郎 总加速师 劝进 慨撒大帝 当皇帝的小丑 习梦撕 nmslese##dream 10号跳跳虎被维尼拉清单 */
package com.pcdd.sonovel.core;

import cn.hutool.core.io.resource.ResourceUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.lang.Opt;
import cn.hutool.json.JSONUtil;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.util.ConfigUtils;
import com.pcdd.sonovel.util.CrawlUtils;
import com.pcdd.sonovel.util.RandomUA;
import org.jsoup.Connection;
import org.jsoup.Jsoup;

import static org.jline.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2024/3/27
 */
public class Source {

    public final Rule rule;
    public final AppConfig config;

    // 配置文件读取书源 id
    public Source(AppConfig config) {
        this(config.getSourceId(), config);
    }

    public Source(int id) {
        this(id, null);
    }

    // 自定义书源 id，用于测试
    public Source(int id, AppConfig config) {
        String jsonStr = null;

        try {
            // 根据 sourceId 获取对应书源规则
            jsonStr = ResourceUtil.readUtf8Str("rule/rule-" + id + ".json");
        } catch (Exception e) {
            Console.error(render("书源规则初始化失败，请检查配置项 source-id 是否正确", "red"));
            Console.error(render("错误信息：{}", "red"), e.getMessage());
            System.exit(1);
        }

        // 将 JSON 转换为 Rule 对象，并应用默认值
        this.rule = applyDefaultTimeouts(JSONUtil.toBean(jsonStr, Rule.class));
        // 使用配置文件中的配置，若为空则使用默认配置
        this.config = Opt.ofNullable(config).orElse(ConfigUtils.config());
    }

    private Rule applyDefaultTimeouts(Rule rule) {
        Rule.Search ruleSearch = rule.getSearch();
        Rule.Book ruleBook = rule.getBook();
        Rule.Toc ruleToc = rule.getToc();
        Rule.Chapter ruleChapter = rule.getChapter();

        if (ruleSearch != null && ruleSearch.getTimeout() == null) {
            ruleSearch.setTimeout(15_000);
        }
        if (ruleBook != null && ruleBook.getTimeout() == null) {
            ruleBook.setTimeout(10_000);
        }
        if (ruleToc != null && ruleToc.getTimeout() == null) {
            ruleToc.setTimeout(30_000);
        }
        if (ruleChapter != null && ruleChapter.getTimeout() == null) {
            ruleChapter.setTimeout(15_000);
        }

        return rule;
    }

    public Connection jsoup(String url) {
        // 除了搜索请求，其他请求基本均为 GET
        String method = rule.getSearch() != null ? rule.getSearch().getMethod() : "GET";

        Connection conn = Jsoup.connect(url)
                .method(CrawlUtils.buildMethod(method))
                .header("User-Agent", RandomUA.generate());

        // 启用配置文件的代理地址
        if (config.getProxyEnabled() == 1) {
            conn.proxy(config.getProxyHost(), config.getProxyPort());
        }

        return conn;
    }

}