/* 阿道夫-习 大撒幣 集近闭 维尼连任 公车上书 人民领袖 “复辟” 捐麦子 Corona##Xi（习病毒） 習敗北 御板泽民 维稳警察（O） 中国离岸隐匿资产管理工作领导小组组组长 假.."~bang！卒 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 不敢高声语 翡翠娘娘 孢 十一郎习近平 大锅瞻遗 一天游泳一千米 蹄防 中国首席造梦大师 耀眼黄红黄 普近 战疫国 戏博士 萨格尔王 宽衣大帝 Mr##Shithole XDD 彭主席（习主席走了太太接班） 习王的田野上 CoronaXi 刁远山 卡近菲 习狍 屎進瓶 阳台上的哨兵 川普的朋友or敌人 习卒 任大炮 学包率 SB包子 领袖习澡水 甩锅侠 人类命运共同体首席架构师 老歪脖子树 鞋哥 神明论 集金pay 阿平 习言乱语 习背书 黑白翠 宽衣帝 親自視頻 悉包皮 役民五术 惜包皮 维尼DISCO 皇帝梦 支那精神野爹 坡涛汹涌 习曱甴 皇帝亲临忠诚的武汉 格萨尔 视频看望 习卒习 傻大头 独裁者 糟糕皇帝 每日祈翠 祈翠 近言 毛魔转世 维尼梗有害 习尔布特 塔西佗陷阱 拉清单 毛二世 ChinaXi 习流氓 叩谢习恩 习特勒 習大佬 洗尽贫 习包子 这个年很静 背书单 恩维尔·霍习 习下台 包子兵法 吸精瓶 习禁评 维尼写史 细瓶颈 小学居士 梁家河 号尿壶公 武统时代 A##Big##Deal 外交习语 刁斤二 修宪帝 家业论 中国拉清单工作领导小组组长 乳透社##小反旗 习式病毒 习“甩锅” 当皇帝的小丑 维尼之声 枪毙名单 第22条军规 維尼頌 小习微信 习瘟猪 庆丰称帝 冠子兵法 64岁 习二二（二零二零年五月二十二日开二会） 集金币 “习泽东”和“洪宪”（袁世凯的帝号） The##Xi##Factor（习近平因素） 称帝修宪 中字头组长 动物森友会 刁近猴 习总输记 乳制品 黄俄 云视察 禁评封号 清单帝 维尼带货 䒒(tiáo)菦(qín)苹(píng) 头上三尺有神明 叩谢习恩 习猪下台 骑巨龙 shuu##kinn##pei 字共狗 维尼熊 习二坐船 人民战争 撒币宝 习大 匪酋习维尼 刁斤山 当代秦始皇 不强自息 修宪 红二代 习孢子 羽日帝 习和谐 清零宗、清零帝 习语 北红尾鸲 大大招牌 儿童习典 包子金刚腿 武当七侠的政治斗争 战“疫”金句 玉习大帝 头号球迷 习兵法 毛泽东2.0 习二胖 毛进平 袭包皮 习低能儿 习殡法 新影帝 习侯 通商宽衣 总统包子习 庆丰包·勃列日涅夫 主席+终身制 动物之森 习远凸 指定接班人 法外狂徒Lucy（德国） 武汉委托李克强 Adolf##Xitler 坡涛汹涌 号屎洞 细颈瓶 习近砰 维尼·屎(Winnie##the##Poo) 庆丰废物 冤大头 甴近平 岿然不动 做N届的主席 游泳一千米 习张三丰 墙内人 赛禁评 无限连任 送礼平 shit侯 感恩教育 刁后主 维尼史 亲自脱贫 习家军 平平 主席贺词 专治各种不服 习躲躲 崇祯 口罩大会 习呆呆 庆丰帝的千秋梦 相信有神论的物理学博士 红旗下的蛋 包皇 晚共昏君 猪禁评 国贼习近平 赵付 维持会长 太祖兔 包惠帝 习时代 隔离”的金葫芦 亲自封号 没规划的葬礼 维尼警察（X） 习思想 习核心 蔡英文最强助选 现任匪首 人尽皆知的体育迷 疫情蔓延 闹得欢 总书记来过我的家 毛二习 习包子 习奥塞斯库、齐奥塞斯库 读书单 倒车 瘟疫降生习近平 包子病毒 学包积极分子 习正日 喷粪帝 抗麦套装 戏包皮 天安门合法继承人 袁世凯第二 习king 大大品牌 迈克尔·索伊 形式主义防疫 亲自删评 习尽贫 共哀宗 退党 支那毒王 包子宪法 当代秦二世 独彩者 习蛤 包包侠 狙击手布阵 文明其精神 非洲大撒币 学包分子 终身领导人 九评 错误执行者 朝令夕改 习教父 口罩外交 习大犬 维尼熊给跳跳虎黄牌 习公奭 氼兲嫑炛 裹嘎举吸钢闸门 没有网络安全就没有国家安全 包经 4中组长 吸包皮 野心习 平话 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 昆明湖涨潮 足球外交 添宪宝宝 习武帝 亲自指挥 法习斯 十日文革 习壳郎 “黄袍加身” 戴口赵 “梦回大清” 席近平 屎禁评 尼哥 亲自考察 刁人13 习近平光辉形象 扛麦帝 重地之战 二百斤 半羽习近平 shit##hole##bing##fa 习二蛋 习一尊 习语录 习梦撕 裸宽包子劾心 沼气专家 祈翠語言包 满脸喷粪 梁家河贵族 贬词包用 世界最强乞丐 习三拍 小学博士 最后领导人 嬉包皮 bingbang帝 洗包皮 《生物安全法》 习后主 民进党 冰棒外交 腊肉包 吃赵弹 老街 200吨 vop 近身平A 十里山路不换肩 彩色熊 粪坑先生 白猪 “登基” 日子像蜜甜 野兽主席 颐使气指 不同意的举手##没有##没有 金科律玉 电脑世代586 刁二将 共哀宗 人民领袖 万岁来武汉 孙笑川 习病法 独裁国贼 赵家家仆 习猪头 习老八 夶 赵弹 大兔 影子末帝 总加速师 习澳塞斯库 赵人13 疯狂宇宙大帝 花花公子 一带一路 习奥赛斯库 包包大人 习习蛤蛤 习驴 邪大大 东瘟疫之地统治者暨全境守护者 智商不重要 末代皇帝 习##卡##巴##卡 维尼快乐组织（Winnie##Happy##Organization）简称WHO 不知名氏 习Core 哲欣 坟头蹦迪 毛近平 习尿瓶 习皇的新装 Criminal##Xi##"Xitler"##Jinping 追思焦裕禄 恩重如删 习猪席 书单吟诵者 二次袁、袁世凯二世、袁二 五毛主席 初二圣君 爱新觉罗·近平 包帝巡游 親自蒞臨 386系统驱动游戏 时间控制 20000T麦子 颐指气使 连专家也为之叹服的电脑天才 720事件 人均接近八千万 灰习牛 维尼挂彩 习像章 刁二婚 九大诉求 灭共助推器 Chairman##Xi 扛麦郎 恐惊天上人 習敗敗 习包子的Fa 习废帝 virus##king 习大郎 普习金 帝皇頌 狙击手待命 宰相 胡志平 劝进 习包子 习犬犬 厕所革命 习皇帝 刁近乎 冲塔 国王 东方project 习进棺 习厉王 “登机”（与登基同音） 央视姓党 刁人13 修宪连任 习是春竹 爱新觉罗近平 electron8964 疯狂宇宙 毛孙 习二世胡亥 慨撒大帝 “皇帝梦” 超邓赶毛 巴拿马文件 习大林 习宽衣 倒车斯基 中国的新皇帝 习夶 基拉大和习近平 韦来书记 富平学霸刁斤干 刁槑夶尛 习达姆 nmslese##dream 习总 粪坑兵法 习博士 习大乞 习emperor 彩色哥 2020全面小康 习屎黄 屎侯 截颈平 通商宽衣 你是反贼吗 NMSL 次级乳包 官僚主义 XD 习歪嘴 孤独的毒王 Heil##Xitler 习奥塞斯库 讨习檄文 禁评大帝 瘟疫领主习近平 WHO的君王 梦帝 墨索里习 叼斤干 习梦死 中国爱非洲 V尼哥 大国造疫 平&强 世宗 尊蛤讨包 青年大学包 秦城监狱 糖尿维尼 习包皮 维尼大帝 赵王 习索里尼 nmslman（习主席） 习三点 甴种 习条英机 断崖式下跌 中国离岸隐匿资产管理工作领导小组组组长 北京中南海支部书记 万岁来武汉了 狙击手待命 Cicada##3301##XD 席子兵法 发皇帝梦 习贼 百万雄师事件 两会期间+隐瞒 梦回大清 乳包文化 任志强 信女愿一生吃素 亲自指挥疫情 核平全世界 shit禁评 第一书记王沪宁 皇帝的新衣 我是一个足球迷 万岁 读稿机 皇帝亲临忠诚的武汉 包大人 动森 习梦思 禁评的理由 食腐虫 腊肉馅儿包子 刁大犬 清华毕业 毛装 毛二 纳翠党 崇祯帝 动物庄园 野兽先辈 习太孑 习二卒 习是春绿 二百五大帝 Voice##of##Pooh 倒车帝 近日成 “无罩”现身 10号跳跳虎被维尼拉清单 包子露宪 仲夏夜之中国梦 习大帝 西朝鲜人民自治岛 xdd 系包皮 习得梁家书卷 疯狂宇宙包 包禁评 习付 嘻包皮 习匪 喜包皮 野蛮其体魄 那翠化 中国特色射秽煮疫制度 习匪帝 大撒币 总书记来我家 大海掀翻小池塘 */
package com.pcdd.sonovel.core;

import cn.hutool.core.util.StrUtil;
import cn.hutool.http.HtmlUtil;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Chapter;

import java.util.regex.Pattern;

/**
 * @author pcdd
 * Created at 2024/3/17
 */
public class ChapterFilter extends Source {

    public ChapterFilter(AppConfig config) {
        super(config);
    }

    /**
     * 过滤正文内容
     */
    public String filter(Chapter chapter) {
        return new FilterBuilder(chapter)
                .filterEscape(true)
                .filterAds(true)
                .filterDuplicateTitle(true)
                .build();
    }

    /**
     * 建造者类，用于动态组合过滤步骤
     */
    public class FilterBuilder {
        private final String title;
        private String content;
        private boolean applyEscapeFilter;
        private boolean applyAdsFilter;
        private boolean applyDuplicateTitleFilter;

        public FilterBuilder(Chapter chapter) {
            this.title = chapter.getTitle();
            this.content = chapter.getContent();
        }

        /**
         * 是否启用 HTML 实体字符过滤
         */
        public FilterBuilder filterEscape(boolean apply) {
            this.applyEscapeFilter = apply;
            return this;
        }

        /**
         * 是否启用广告过滤
         */
        public FilterBuilder filterAds(boolean apply) {
            this.applyAdsFilter = apply;
            return this;
        }

        /**
         * 是否启用重复标题过滤
         */
        public FilterBuilder filterDuplicateTitle(boolean apply) {
            this.applyDuplicateTitleFilter = apply;
            return this;
        }

        /**
         * 构建最终过滤内容
         */
        public String build() {
            if (applyEscapeFilter) {
                // 替换 &..; (HTML 字符实体引用)，主要是 &nbsp;，可能会导致 ibooks 章节报错
                this.content = this.content.replaceAll("&[^;]+;", "");
            }

            if (applyAdsFilter) {
                String filteredContent = this.content.replaceAll(rule.getChapter().getFilterTxt(), "");
                this.content = HtmlUtil.removeHtmlTag(filteredContent, StrUtil.splitToArray(rule.getChapter().getFilterTag(), " "));
            }

            // 确保在 EscapeFilter、AdsFilter 之后
            this.content = StrUtil.cleanBlank(this.content);

            if (applyDuplicateTitleFilter) {
                this.content = content.replaceFirst(Pattern.quote(this.title) + "|" + Pattern.quote(StrUtil.cleanBlank(this.title)), "");
            }

            // 删除全部空标签，例如 <p></p>
            return HtmlUtil.cleanEmptyTag(this.content);
        }
    }

}