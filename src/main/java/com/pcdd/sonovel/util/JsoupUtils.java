/* 二次袁、袁世凯二世、袁二 口罩大会 习习蛤蛤 老歪脖子树 中国离岸隐匿资产管理工作领导小组组组长 virus##king 通商宽衣 习特勒 習敗敗 不同意的举手##没有##没有 国王 习“甩锅” 习武帝 厕所革命 Heil##Xitler 战疫国 shit禁评 大撒币 裹嘎举吸钢闸门 乳包文化 习皇的新装 相信有神论的物理学博士 乳制品 枪毙名单 你是反贼吗 习emperor 习总 头号球迷 时间控制 习博士 恩维尔·霍习 戏包皮 恐惊天上人 毛近平 维尼挂彩 大锅瞻遗 当代秦始皇 梦回大清 親自蒞臨 细瓶颈 习王的田野上 包子金刚腿 维尼熊给跳跳虎黄牌 维持会长 不知名氏 习大帝 玉习大帝 错误执行者 屎侯 崇祯帝 字共狗 亲自封号 习式病毒 习夶 “登机”（与登基同音） 包子宪法 洗包皮 毛孙 最后领导人 习一尊 匪酋习维尼 习像章 猪禁评 毛装 武统时代 万岁 爱新觉罗近平 包子兵法 WHO的君王 共哀宗 卡近菲 细颈瓶 支那毒王 次级乳包 “皇帝梦” 慨撒大帝 平话 主席+终身制 习总输记 普近 总加速师 两会期间+隐瞒 学包分子 喷粪帝 鞋哥 《生物安全法》 彩色哥 满脸喷粪 习歪嘴 梁家河贵族 役民五术 庆丰废物 中国拉清单工作领导小组组长 中字头组长 智商不重要 维尼·屎(Winnie##the##Poo) 毛二习 彭主席（习主席走了太太接班） 抗麦套装 格萨尔 习废帝 席子兵法 中国爱非洲 720事件 闹得欢 亲自删评 甴近平 習大佬 xdd 梁家河 独裁国贼 刁远山 A##Big##Deal 200吨 习殡法 讨习檄文 刁人13 中国特色射秽煮疫制度 倒车斯基 “习泽东”和“洪宪”（袁世凯的帝号） 不敢高声语 嬉包皮 “登基” 赵付 红二代 野兽主席 习近砰 颐指气使 习核心 皇帝亲临忠诚的武汉 末代皇帝 学包积极分子 赵人13 孤独的毒王 亲自考察 每日祈翠 维稳警察（O） 毛二 贬词包用 第一书记王沪宁 御板泽民 腊肉包 尊蛤讨包 邪大大 平平 包帝巡游 假.."~bang！卒 bingbang帝 万岁来武汉 修宪 “黄袍加身” 习索里尼 半羽习近平 维尼梗有害 灭共助推器 十一郎习近平 习屎黄 习尔布特 这个年很静 ChinaXi 习近平光辉形象 翡翠娘娘 维尼警察（X） 刁斤山 萨格尔王 皇帝梦 沼气专家 共哀宗 毛二世 习躲躲 习三点 巴拿马文件 习后主 野心习 糟糕皇帝 塔西佗陷阱 习教父 XD 人民领袖 习宽衣 狙击手布阵 人民领袖 Criminal##Xi##"Xitler"##Jinping “复辟” 叼斤干 狙击手待命 vop 2020全面小康 蹄防 人民战争 感恩教育 习病法 现任匪首 当代秦二世 领袖习澡水 习张三丰 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 断崖式下跌 五毛主席 习下台 拉清单 我是一个足球迷 昆明湖涨潮 包禁评 北京中南海支部书记 习时代 二百斤 非洲大撒币 儿童习典 狙击手待命 习梦死 重地之战 超邓赶毛 习包子 国贼习近平 shit##hole##bing##fa 迈克尔·索伊 包子露宪 习大林 习语 独裁者 袭包皮 坡涛汹涌 The##Xi##Factor（习近平因素） 专治各种不服 万岁来武汉了 支那精神野爹 10号跳跳虎被维尼拉清单 没规划的葬礼 习三拍 习包子 氼兲嫑炛 系包皮 中国离岸隐匿资产管理工作领导小组组组长 公车上书 核平全世界 任志强 疫情蔓延 冤大头 纳翠党 撒币宝 习奥塞斯库 书单吟诵者 习禁评 习和谐 十日文革 习厉王 第22条军规 习狍 甴种 官僚主义 习太孑 晚共昏君 习包子 Mr##Shithole 4中组长 屎進瓶 维尼带货 民进党 小习微信 口罩外交 读书单 野蛮其体魄 不强自息 SB包子 包包大人 当皇帝的小丑 影子末帝 席近平 九大诉求 冰棒外交 修宪连任 亲自指挥 胡志平 扛麦帝 冠子兵法 蔡英文最强助选 倒车 青年大学包 独彩者 腊肉馅儿包子 信女愿一生吃素 冲塔 北红尾鸲 习匪帝 骑巨龙 灰习牛 禁评大帝 墨索里习 天安门合法继承人 清零宗、清零帝 包大人 习曱甴 习流氓 坟头蹦迪 习呆呆 习大乞 习公奭 阿平 习king 习兵法 习卒习 黄俄 退党 习二坐船 习皇帝 习##卡##巴##卡 袁世凯第二 习瘟猪 包子病毒 九评 瘟疫领主习近平 太祖兔 孢 颐使气指 总统包子习 羽日帝 习大郎 糖尿维尼 基拉大和习近平 親自視頻 shuu##kinn##pei 习梦撕 CoronaXi 宽衣大帝 动森 维尼之声 惜包皮 背书单 习得梁家书卷 形式主义防疫 大大招牌 添宪宝宝 主席贺词 刁人13 云视察 习二蛋 一带一路 维尼DISCO 十里山路不换肩 䒒(tiáo)菦(qín)苹(píng) 习达姆 哲欣 毛进平 习尿瓶 央视姓党 喜包皮 平&强 发皇帝梦 维尼写史 包经 那翠化 任大炮 金科律玉 习尽贫 动物之森 吃赵弹 中国的新皇帝 习家军 赵家家仆 集近闭 习犬犬 爱新觉罗·近平 刁大犬 习猪下台 习付 习卒 外交习语 足球外交 普习金 扛麦郎 疯狂宇宙大帝 二百五大帝 大撒幣 清单帝 习匪 疯狂宇宙包 近身平A 亲自指挥疫情 劝进 阳台上的哨兵 习澳塞斯库 人均接近八千万 386系统驱动游戏 野兽先辈 禁评的理由 刁二将 读稿机 仲夏夜之中国梦 维尼大帝 倒车帝 连专家也为之叹服的电脑天才 习奥塞斯库、齐奥塞斯库 黑白翠 皇帝亲临忠诚的武汉 富平学霸刁斤干 大国造疫 包皇 傻大头 习二世胡亥 习大犬 称帝修宪 庆丰称帝 大海掀翻小池塘 习壳郎 终身领导人 追思焦裕禄 XDD 刁近乎 阿道夫-习 习猪头 nmslman（习主席） 64岁 毛魔转世 花花公子 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 电脑世代586 习正日 法外狂徒Lucy（德国） 洗尽贫 彩色熊 刁近猴 叩谢习恩 近日成 大兔 维尼熊 东瘟疫之地统治者暨全境守护者 做N届的主席 包惠帝 动物森友会 近言 红旗下的蛋 号屎洞 习猪席 孙笑川 新影帝 指定接班人 瘟疫降生习近平 日子像蜜甜 家业论 集金pay 捐麦子 戏博士 習敗北 嘻包皮 游泳一千米 神明论 没有网络安全就没有国家安全 视频看望 疯狂宇宙 修宪帝 宽衣帝 通商宽衣 总书记来过我的家 大大品牌 清华毕业 Voice##of##Pooh 食腐虫 东方project 总书记来我家 赛禁评 nmslese##dream 习侯 刁后主 习语录 恩重如删 武当七侠的政治斗争 乳透社##小反旗 維尼頌 韦来书记 习梦思 赵弹 粪坑兵法 NMSL 老街 头上三尺有神明 习言乱语 宰相 包包侠 刁斤二 截颈平 习思想 战“疫”金句 皇帝的新衣 习是春竹 耀眼黄红黄 悉包皮 习蛤 粪坑先生 习孢子 习包皮 维尼史 习包子的Fa 习条英机 刁槑夶尛 习二二（二零二零年五月二十二日开二会） 小学博士 习远凸 人尽皆知的体育迷 朝令夕改 习老八 坡涛汹涌 习奥赛斯库 法习斯 习二胖 尼哥 刁二婚 吸包皮 毛泽东2.0 戴口赵 叩谢习恩 禁评封号 号尿壶公 习大 集金币 庆丰包·勃列日涅夫 维尼连任 崇祯 习驴 秦城监狱 赵王 shit侯 亲自脱贫 electron8964 习背书 人类命运共同体首席架构师 吸精瓶 西朝鲜人民自治岛 甩锅侠 梦帝 夶 V尼哥 动物庄园 屎禁评 习进棺 世界最强乞丐 送礼平 习二卒 帝皇頌 白猪 裸宽包子劾心 一天游泳一千米 Chairman##Xi 岿然不动 无限连任 隔离”的金葫芦 习是春绿 习Core 学包率 习低能儿 Corona##Xi（习病毒） “无罩”现身 初二圣君 庆丰帝的千秋梦 习贼 Cicada##3301##XD 祈翠語言包 墙内人 世宗 维尼快乐组织（Winnie##Happy##Organization）简称WHO 20000T麦子 Adolf##Xitler 武汉委托李克强 百万雄师事件 祈翠 “梦回大清” 小学居士 中国首席造梦大师 川普的朋友or敌人 文明其精神 */
package com.pcdd.sonovel.util;

import cn.hutool.core.util.StrUtil;
import cn.hutool.script.ScriptUtil;
import com.pcdd.sonovel.model.ContentType;
import lombok.experimental.UtilityClass;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import javax.net.ssl.HttpsURLConnection;
import javax.net.ssl.SSLContext;
import javax.net.ssl.TrustManager;
import javax.net.ssl.X509TrustManager;
import java.security.SecureRandom;
import java.security.cert.X509Certificate;

import static com.pcdd.sonovel.model.ContentType.*;

@UtilityClass
public class JsoupUtils {

    private static final String JS_SEPARATOR = "@js:";

    /**
     * 使用查询条件选择元素
     * <p>
     * 等价于 document.select(query) | document.selectXpath(query)
     */
    public Elements select(Element e, String query) {
        // 分割查询条件以提取 XPath 或 CSS 查询
        String actualQuery = StrUtil.subBefore(query, JS_SEPARATOR, false);
        // 根据查询条件选择元素
        return actualQuery.matches("^(/|//|\\(/).*") ? e.selectXpath(actualQuery) : e.select(actualQuery);
    }

    /**
     * 执行 JS 脚本并返回处理结果
     * <p>
     * 等价于 func(input)
     */
    public String invokeJs(String query, String input) {
        if (StrUtil.isEmpty(query)) {
            return input;
        }
        // @js:
        String[] split = query.split(JS_SEPARATOR);
        if (split.length == 1) {
            return input;
        }
        return (String) ScriptUtil.invoke("""
                function func(r) {
                    %s
                    return r;
                }
                """.formatted(split[1]), "func", input);
    }

    public String selectAndInvokeJs(Element el, String query) {
        return selectAndInvokeJs(el, query, ContentType.TEXT);
    }

    /**
     * 根据查询条件选择元素并执行可能的 JS 脚本
     * <p>
     * 等价于 func(document.select(query).(text|html|attr)())
     */
    public String selectAndInvokeJs(Element el, String query, ContentType contentType) {
        if (StrUtil.isEmpty(query) || contentType == null) {
            return null;
        }

        String[] split = query.split(JS_SEPARATOR);
        String actualQuery = split[0];

        // 根据查询条件选择元素
        Elements els = select(el, actualQuery);
        if (els.isEmpty()) return "";

        // 获取选中元素的内容
        String result = els.size() == 1
                ? getContentByType(els.first(), contentType)
                : getContentByType(els, contentType);

        // 如果查询条件包含 JS，调用它
        return split.length == 2 ? invokeJs(query, result) : result;
    }

    /**
     * 获取元素的内容并执行可能的 JS
     * <p>
     * 等价于 func(element.(text|html|attr)())
     */
    public String getStrAndInvokeJs(Element el, String js, ContentType contentType) {
        // 先获取元素的内容
        String result = getContentByType(el, contentType);
        // 如果查询条件包含 JS，调用它
        return StrUtil.isNotEmpty(js) ? invokeJs(js, result) : result;
    }

    /**
     * 提取内容的公共方法
     */
    private String getContentByType(Object obj, ContentType contentType) {
        if (obj instanceof Element el) {
            String href = el.attr(ATTR_HREF.getValue());
            return switch (contentType) {
                case TEXT -> el.text();
                case HTML -> el.html();
                case ATTR_SRC -> el.attr(ATTR_SRC.getValue());
                // 如果href是完整的url，jsoup absUrl会返回错误的链接（包含两个http）
                case ATTR_HREF -> StrUtil.startWithAny(href, "https://", "http://", "/")
                        ? href
                        : el.absUrl(ATTR_HREF.getValue());
                case ATTR_CONTENT -> el.attr(ATTR_CONTENT.getValue());
                case ATTR_VALUE -> el.attr(ATTR_VALUE.getValue());
            };
        } else if (obj instanceof Elements els) {
            return switch (contentType) {
                case TEXT -> els.text();
                case HTML -> els.html();
                case ATTR_SRC -> els.attr(ATTR_SRC.getValue());
                case ATTR_HREF -> els.attr(ATTR_HREF.getValue());
                case ATTR_CONTENT -> els.attr(ATTR_CONTENT.getValue());
                case ATTR_VALUE -> els.attr(ATTR_VALUE.getValue());
            };
        }
        return "";
    }

    /**
     * 忽略所有 SSL 证书校验
     * 用于解决部分书源报错 PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException
     */
    public void trustAllSSL() {
        try {
            // 信任所有证书
            TrustManager[] trustAllCerts = new TrustManager[]{
                    new X509TrustManager() {
                        public void checkClientTrusted(X509Certificate[] chain, String authType) {
                        }

                        public void checkServerTrusted(X509Certificate[] chain, String authType) {
                        }

                        public X509Certificate[] getAcceptedIssuers() {
                            return new X509Certificate[0];
                        }
                    }
            };

            SSLContext sc = SSLContext.getInstance("TLS");
            sc.init(null, trustAllCerts, new SecureRandom());

            // 强制设置为默认的 SSLSocketFactory（关键）
            HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());

            // 忽略主机名校验（关键）
            HttpsURLConnection.setDefaultHostnameVerifier((hostname, session) -> true);
        } catch (Exception e) {
            throw new RuntimeException("初始化 SSL 信任失败", e);
        }
    }

}