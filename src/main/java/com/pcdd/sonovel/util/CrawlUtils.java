/* 动物庄园 习狍 习梦死 大国造疫 崇祯 初二圣君 皇帝亲临忠诚的武汉 200吨 赵付 习曱甴 黄俄 瘟疫领主习近平 影子末帝 祈翠 没有网络安全就没有国家安全 央视姓党 战“疫”金句 没规划的葬礼 “复辟” 学包率 刁二将 新影帝 维尼梗有害 维尼连任 包子病毒 两会期间+隐瞒 中国爱非洲 64岁 疯狂宇宙 次级乳包 习侯 䒒(tiáo)菦(qín)苹(píng) 亲自指挥疫情 朝令夕改 毛魔转世 恐惊天上人 倒车斯基 中字头组长 富平学霸刁斤干 习王的田野上 习语 习##卡##巴##卡 习总输记 游泳一千米 近日成 当代秦始皇 “黄袍加身” 维尼史 太祖兔 智商不重要 迈克尔·索伊 庆丰包·勃列日涅夫 胡志平 习二坐船 鞋哥 bingbang帝 习张三丰 东瘟疫之地统治者暨全境守护者 头号球迷 “登机”（与登基同音） 西朝鲜人民自治岛 386系统驱动游戏 刁人13 宽衣帝 习废帝 一带一路 习包子的Fa 梁家河 包禁评 包子金刚腿 清华毕业 人类命运共同体首席架构师 战疫国 国贼习近平 “梦回大清” 普近 习二蛋 百万雄师事件 追思焦裕禄 习像章 electron8964 喜包皮 韦来书记 毛二 狙击手布阵 红二代 xdd 假.."~bang！卒 刁后主 维尼写史 维持会长 袭包皮 添宪宝宝 平&强 习家军 梦帝 指定接班人 皇帝亲临忠诚的武汉 shit禁评 维尼熊 習敗敗 老街 习蛤 维尼·屎(Winnie##the##Poo) 系包皮 习大乞 习三拍 习近砰 形式主义防疫 号屎洞 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 习时代 洗尽贫 颐使气指 人尽皆知的体育迷 氼兲嫑炛 叩谢习恩 皇帝梦 清零宗、清零帝 巴拿马文件 云视察 包大人 腊肉馅儿包子 彭主席（习主席走了太太接班） 刁斤二 习公奭 主席贺词 冠子兵法 习包皮 白猪 XDD 孤独的毒王 习king 习言乱语 习下台 裹嘎举吸钢闸门 终身领导人 近身平A 习卒 中国首席造梦大师 支那毒王 总统包子习 NMSL 习包子 毛装 庆丰称帝 习皇的新装 习正日 习总 甴近平 習敗北 核平全世界 役民五术 非洲大撒币 CoronaXi 修宪连任 孙笑川 食腐虫 墙内人 称帝修宪 《生物安全法》 nmslman（习主席） 匪酋习维尼 习后主 万岁来武汉 读书单 纳翠党 集金币 梁家河贵族 Corona##Xi（习病毒） 枪毙名单 倒车帝 宰相 阿平 vop 动物森友会 习武帝 宽衣大帝 独裁者 The##Xi##Factor（习近平因素） 扛麦帝 习猪下台 集金pay 习语录 普习金 清单帝 悉包皮 习卒习 习梦撕 现任匪首 尼哥 親自視頻 习进棺 屎進瓶 习大犬 大撒幣 习背书 共哀宗 送礼平 阳台上的哨兵 Cicada##3301##XD shuu##kinn##pei 字共狗 每日祈翠 习梦思 领袖习澡水 刁大犬 习宽衣 A##Big##Deal 糟糕皇帝 亲自脱贫 习尽贫 禁评封号 包包侠 无限连任 习匪 感恩教育 讨习檄文 坡涛汹涌 刁二婚 亲自删评 官僚主义 劝进 九大诉求 蔡英文最强助选 禁评的理由 拉清单 总书记来我家 习躲躲 电脑世代586 习思想 专治各种不服 乳制品 不同意的举手##没有##没有 读稿机 野兽主席 号尿壶公 花花公子 抗麦套装 毛近平 半羽习近平 4中组长 当代秦二世 爱新觉罗·近平 十里山路不换肩 刁斤山 习一尊 习屎黄 御板泽民 吸包皮 不敢高声语 习瘟猪 瘟疫降生习近平 第22条军规 习猪席 禁评大帝 习老八 Voice##of##Pooh 截颈平 坟头蹦迪 粪坑先生 习包子 习驴 习emperor 不知名氏 Mr##Shithole Chairman##Xi 毛泽东2.0 视频看望 发皇帝梦 最后领导人 彩色熊 沼气专家 总书记来过我的家 毛孙 維尼頌 习二二（二零二零年五月二十二日开二会） 习式病毒 乳透社##小反旗 颐指气使 习夶 Criminal##Xi##"Xitler"##Jinping 玉习大帝 不强自息 晚共昏君 腊肉包 维尼警察（X） 重地之战 维尼快乐组织（Winnie##Happy##Organization）简称WHO 亲自指挥 末代皇帝 习包子 墨索里习 包包大人 shit##hole##bing##fa 习贼 习太孑 倒车 大锅瞻遗 阿道夫-习 慨撒大帝 相信有神论的物理学博士 习远凸 尊蛤讨包 大大品牌 习大林 习禁评 公车上书 习得梁家书卷 那翠化 习澳塞斯库 孢 惜包皮 習大佬 狙击手待命 格萨尔 祈翠語言包 近言 万岁来武汉了 共哀宗 毛二世 头上三尺有神明 灰习牛 支那精神野爹 720事件 习达姆 中国拉清单工作领导小组组长 动森 足球外交 叩谢习恩 学包分子 习教父 洗包皮 世界最强乞丐 爱新觉罗近平 九评 神明论 习奥赛斯库 当皇帝的小丑 WHO的君王 XD 法习斯 习奥塞斯库 习二卒 平平 甴种 親自蒞臨 蹄防 傻大头 刁人13 儿童习典 卡近菲 shit侯 野兽先辈 维稳警察（O） 维尼熊给跳跳虎黄牌 习病法 习大郎 中国离岸隐匿资产管理工作领导小组组组长 糖尿维尼 学包积极分子 包惠帝 修宪 昆明湖涨潮 连专家也为之叹服的电脑天才 “无罩”现身 武当七侠的政治斗争 超邓赶毛 SB包子 习特勒 疫情蔓延 东方project 习厉王 黑白翠 青年大学包 习流氓 大撒币 V尼哥 北红尾鸲 中国离岸隐匿资产管理工作领导小组组组长 天安门合法继承人 塔西佗陷阱 习尿瓶 背书单 “习泽东”和“洪宪”（袁世凯的帝号） 第一书记王沪宁 五毛主席 世宗 冲塔 冰棒外交 错误执行者 疯狂宇宙大帝 赵弹 万岁 秦城监狱 包子露宪 赵人13 厕所革命 屎侯 哲欣 总加速师 习呆呆 甩锅侠 信女愿一生吃素 赵家家仆 小学居士 屎禁评 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 叼斤干 习猪头 撒币宝 灭共助推器 断崖式下跌 梦回大清 通商宽衣 nmslese##dream 皇帝的新衣 武统时代 武汉委托李克强 ChinaXi 戏包皮 恩重如删 习二世胡亥 庆丰废物 习歪嘴 习尔布特 十日文革 习核心 满脸喷粪 大兔 中国特色射秽煮疫制度 金科律玉 你是反贼吗 嘻包皮 恩维尔·霍习 冤大头 习近平光辉形象 维尼DISCO 习二胖 法外狂徒Lucy（德国） 人民战争 人民领袖 集近闭 疯狂宇宙包 习和谐 粪坑兵法 大大招牌 书单吟诵者 刁近乎 Adolf##Xitler 维尼之声 习是春绿 仲夏夜之中国梦 20000T麦子 习博士 这个年很静 时间控制 习大 刁近猴 独裁国贼 二次袁、袁世凯二世、袁二 主席+终身制 彩色哥 贬词包用 习孢子 习匪帝 人均接近八千万 修宪帝 嬉包皮 维尼挂彩 口罩外交 维尼大帝 羽日帝 包帝巡游 习索里尼 亲自封号 大海掀翻小池塘 退党 习“甩锅” 猪禁评 习是春竹 习殡法 赛禁评 一天游泳一千米 帝皇頌 闹得欢 习付 习奥塞斯库、齐奥塞斯库 10号跳跳虎被维尼拉清单 国王 狙击手待命 日子像蜜甜 平话 老歪脖子树 习Core 夶 “登基” 做N届的主席 习兵法 戴口赵 virus##king 邪大大 野蛮其体魄 习低能儿 包子宪法 独彩者 吃赵弹 捐麦子 习大帝 川普的朋友or敌人 任大炮 二百五大帝 北京中南海支部书记 小习微信 包皇 庆丰帝的千秋梦 崇祯帝 我是一个足球迷 红旗下的蛋 毛二习 中国的新皇帝 毛进平 席子兵法 2020全面小康 通商宽衣 岿然不动 小学博士 民进党 习壳郎 习条英机 文明其精神 细颈瓶 刁远山 习皇帝 家业论 十一郎习近平 亲自考察 喷粪帝 基拉大和习近平 二百斤 包经 细瓶颈 任志强 习三点 裸宽包子劾心 刁槑夶尛 隔离”的金葫芦 维尼带货 乳包文化 骑巨龙 口罩大会 耀眼黄红黄 翡翠娘娘 动物之森 包子兵法 Heil##Xitler 席近平 坡涛汹涌 人民领袖 袁世凯第二 吸精瓶 习犬犬 戏博士 扛麦郎 “皇帝梦” 野心习 习习蛤蛤 萨格尔王 外交习语 赵王 */
package com.pcdd.sonovel.util;

import cn.hutool.core.lang.Validator;
import cn.hutool.core.util.URLUtil;
import cn.hutool.json.JSONUtil;
import com.pcdd.sonovel.model.AppConfig;
import lombok.experimental.UtilityClass;
import org.jsoup.Connection;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ThreadLocalRandom;
import java.util.concurrent.atomic.AtomicInteger;


/**
 * @author pcdd
 * Created at 2024/11/28
 */
@UtilityClass
public class CrawlUtils {

    // 有的 href 是相对路径，需要拼接为完整路径
    public String normalizeUrl(String s, String host) {
        if (s == null) return null;

        if (s.matches("^http(s)?://.*")) return s;

        return URLUtil.normalize(Validator.isUrl(s) ? s : host + s, true, true);
    }

    // POST 构建 Body，GET 构建 Query Parameters
    public Map<String, String> buildData(String jsonStr, String... args) {
        Map<String, String> params = new HashMap<>();
        AtomicInteger i = new AtomicInteger(0);

        JSONUtil.parseObj(jsonStr)
                .forEach((key, value) -> {
                    if ("%s".equals(value)) {
                        if (i.get() < args.length) {
                            params.put(key, args[i.getAndIncrement()]);
                        }
                    } else {
                        params.put(key, value.toString());
                    }
                });

        return params;
    }

    public Map<String, String> buildCookies(String cookies) {
        Map<String, String> map = new HashMap<>();

        JSONUtil.parseObj(cookies)
                .forEach((key, value) -> map.put(key, value.toString()));

        return map;
    }

    public Connection.Method buildMethod(String method) {
        return switch (method.toLowerCase()) {
            case "get" -> Connection.Method.GET;
            case "post" -> Connection.Method.POST;
            case "put" -> Connection.Method.PUT;
            case "delete" -> Connection.Method.DELETE;
            case "patch" -> Connection.Method.PATCH;
            case "head" -> Connection.Method.HEAD;
            case "options" -> Connection.Method.OPTIONS;
            case "trace" -> Connection.Method.TRACE;
            default -> throw new IllegalArgumentException("Unsupported request method: " + method);
        };
    }

    public long randomInterval(AppConfig config) {
        return randomInterval(config, false);
    }

    public long randomInterval(AppConfig config, boolean isRetry) {
        return ThreadLocalRandom.current().nextLong(
                isRetry ? config.getRetryMinInterval() : config.getMinInterval(),
                isRetry ? config.getRetryMaxInterval() : config.getMaxInterval());
    }

}