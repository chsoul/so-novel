/* 习曱甴 宰相 读稿机 傻大头 追思焦裕禄 维持会长 民进党 小学博士 沼气专家 赵家家仆 称帝修宪 集金币 习远凸 仲夏夜之中国梦 裸宽包子劾心 大大招牌 习厉王 习##卡##巴##卡 满脸喷粪 红旗下的蛋 坡涛汹涌 动物之森 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 习近平光辉形象 習敗北 习下台 习大乞 维尼之声 赵王 electron8964 役民五术 习包子 新影帝 近言 习三点 厕所革命 尊蛤讨包 送礼平 亲自封号 扛麦帝 现任匪首 灭共助推器 瘟疫领主习近平 世界最强乞丐 刁后主 大撒币 毛魔转世 习梦撕 每日祈翠 吃赵弹 坡涛汹涌 扛麦郎 疯狂宇宙包 电脑世代586 毛装 平&强 青年大学包 十里山路不换肩 习流氓 习二卒 xdd 梦回大清 习二坐船 刁二将 第一书记王沪宁 习卒 習大佬 屎侯 耀眼黄红黄 狙击手布阵 假.."~bang！卒 刁斤二 皇帝的新衣 习是春竹 习宽衣 神明论 非洲大撒币 习后主 习二世胡亥 不强自息 習敗敗 戏包皮 习尔布特 格萨尔 《生物安全法》 法外狂徒Lucy（德国） 韦来书记 做N届的主席 习公奭 The##Xi##Factor（习近平因素） 恩重如删 骑巨龙 花花公子 习澳塞斯库 习老八 习尿瓶 包子兵法 超邓赶毛 包惠帝 袭包皮 哲欣 习狍 维尼·屎(Winnie##the##Poo) 独彩者 形式主义防疫 习包子 祈翠語言包 习躲躲 叩谢习恩 习猪下台 专治各种不服 细瓶颈 总书记来过我的家 禁评封号 习近砰 习张三丰 疫情蔓延 彭主席（习主席走了太太接班） 习梦思 喜包皮 亲自考察 维稳警察（O） 核平全世界 食腐虫 习奥塞斯库 习殡法 书单吟诵者 习大帝 万岁来武汉 学包分子 通商宽衣 习大林 头号球迷 Criminal##Xi##"Xitler"##Jinping “梦回大清” 720事件 庆丰称帝 叩谢习恩 nmslman（习主席） 喷粪帝 富平学霸刁斤干 毛进平 糖尿维尼 禁评大帝 Voice##of##Pooh 大海掀翻小池塘 家业论 字共狗 乳包文化 粪坑兵法 墙内人 黑白翠 朝令夕改 nmslese##dream 倒车斯基 孢 习奥塞斯库、齐奥塞斯库 百万雄师事件 习“甩锅” 毛二 刁远山 习特勒 习思想 次级乳包 时间控制 十日文革 塔西佗陷阱 细颈瓶 系包皮 刁大犬 川普的朋友or敌人 集近闭 崇祯帝 親自蒞臨 习猪头 毛二习 梦帝 中国离岸隐匿资产管理工作领导小组组组长 包子宪法 吸精瓶 习大郎 皇帝亲临忠诚的武汉 退党 野兽先辈 习皇帝 野心习 太祖兔 秦城监狱 蔡英文最强助选 小学居士 终身领导人 包经 瘟疫降生习近平 XD 清零宗、清零帝 习呆呆 习猪席 学包率 甴近平 万岁 大大品牌 习博士 西朝鲜人民自治岛 WHO的君王 习王的田野上 拉清单 CoronaXi Cicada##3301##XD 包子露宪 彩色熊 习教父 习语 习贼 坟头蹦迪 修宪连任 宽衣帝 胡志平 梁家河贵族 庆丰废物 习匪 乳透社##小反旗 支那毒王 背书单 匪酋习维尼 席近平 平话 玉习大帝 游泳一千米 乳制品 文明其精神 习包子 嬉包皮 中国的新皇帝 国贼习近平 墨索里习 维尼史 习病法 惜包皮 习蛤 亲自删评 shit##hole##bing##fa 包子金刚腿 二百五大帝 中国首席造梦大师 习低能儿 捐麦子 云视察 添宪宝宝 连专家也为之叹服的电脑天才 日子像蜜甜 习二蛋 读书单 親自視頻 灰习牛 五毛主席 V尼哥 独裁者 口罩大会 刁近乎 习皇的新装 当代秦二世 包皇 习武帝 64岁 错误执行者 习语录 不知名氏 戴口赵 主席+终身制 习一尊 狙击手待命 指定接班人 习壳郎 維尼頌 亲自指挥 世宗 NMSL 冰棒外交 初二圣君 抗麦套装 恐惊天上人 2020全面小康 武汉委托李克强 萨格尔王 任大炮 习Core 席子兵法 你是反贼吗 屎進瓶 中国特色射秽煮疫制度 总统包子习 口罩外交 virus##king 习emperor 爱新觉罗·近平 习习蛤蛤 万岁来武汉了 “登基” 清单帝 习二二（二零二零年五月二十二日开二会） 宽衣大帝 习条英机 影子末帝 近身平A “复辟” 疯狂宇宙 央视姓党 号屎洞 包禁评 疯狂宇宙大帝 386系统驱动游戏 维尼挂彩 习太孑 大国造疫 “皇帝梦” 当代秦始皇 习屎黄 颐指气使 彩色哥 公车上书 隔离”的金葫芦 习总输记 洗尽贫 迈克尔·索伊 “无罩”现身 Chairman##Xi 武当七侠的政治斗争 庆丰包·勃列日涅夫 足球外交 二百斤 祈翠 撒币宝 十一郎习近平 夶 总书记来我家 武统时代 战“疫”金句 学包积极分子 毛二世 皇帝亲临忠诚的武汉 近日成 毛泽东2.0 习犬犬 “习泽东”和“洪宪”（袁世凯的帝号） 糟糕皇帝 官僚主义 “黄袍加身” 习像章 维尼大帝 那翠化 习是春绿 头上三尺有神明 白猪 A##Big##Deal 鞋哥 总加速师 国王 倒车帝 Heil##Xitler 习卒习 崇祯 这个年很静 九评 习匪帝 习奥赛斯库 洗包皮 习歪嘴 亲自脱贫 当皇帝的小丑 悉包皮 翡翠娘娘 野兽主席 刁槑夶尛 末代皇帝 颐使气指 一带一路 Mr##Shithole 赵付 人均接近八千万 红二代 倒车 习进棺 孤独的毒王 羽日帝 劝进 shuu##kinn##pei 金科律玉 维尼熊给跳跳虎黄牌 梁家河 习大犬 讨习檄文 智商不重要 维尼写史 习驴 北京中南海支部书记 叼斤干 腊肉包 200吨 恩维尔·霍习 氼兲嫑炛 “登机”（与登基同音） 中字头组长 东瘟疫之地统治者暨全境守护者 习瘟猪 习夶 号尿壶公 bingbang帝 刁人13 维尼带货 禁评的理由 孙笑川 普近 儿童习典 法习斯 昆明湖涨潮 ChinaXi 截颈平 通商宽衣 包包大人 二次袁、袁世凯二世、袁二 习索里尼 不同意的举手##没有##没有 习尽贫 vop 甴种 阳台上的哨兵 大锅瞻遗 冲塔 巴拿马文件 维尼警察（X） 习禁评 习式病毒 人民领袖 蹄防 习核心 维尼DISCO 枪毙名单 慨撒大帝 大撒幣 感恩教育 晚共昏君 习二胖 发皇帝梦 亲自指挥疫情 平平 半羽习近平 基拉大和习近平 袁世凯第二 习付 习废帝 大兔 老歪脖子树 人尽皆知的体育迷 第22条军规 没有网络安全就没有国家安全 邪大大 习家军 相信有神论的物理学博士 人民战争 维尼梗有害 视频看望 主席贺词 屎禁评 20000T麦子 断崖式下跌 赵人13 动物庄园 战疫国 闹得欢 没规划的葬礼 习侯 包大人 习总 领袖习澡水 人类命运共同体首席架构师 包帝巡游 天安门合法继承人 最后领导人 九大诉求 冠子兵法 阿平 维尼快乐组织（Winnie##Happy##Organization）简称WHO 习言乱语 爱新觉罗近平 尼哥 粪坑先生 我是一个足球迷 贬词包用 北红尾鸲 人民领袖 戏博士 集金pay 中国离岸隐匿资产管理工作领导小组组组长 刁斤山 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 习包皮 御板泽民 SB包子 习时代 䒒(tiáo)菦(qín)苹(píng) 中国拉清单工作领导小组组长 庆丰帝的千秋梦 shit禁评 东方project 阿道夫-习 老街 嘻包皮 外交习语 习背书 支那精神野爹 帝皇頌 岿然不动 甩锅侠 猪禁评 清华毕业 习正日 4中组长 野蛮其体魄 狙击手待命 皇帝梦 习三拍 吸包皮 习孢子 中国爱非洲 信女愿一生吃素 10号跳跳虎被维尼拉清单 习大 两会期间+隐瞒 冤大头 重地之战 一天游泳一千米 动森 黄俄 Corona##Xi（习病毒） shit侯 习达姆 Adolf##Xitler 习king 习梦死 赵弹 修宪 独裁国贼 刁近猴 共哀宗 习得梁家书卷 刁二婚 纳翠党 小习微信 毛孙 维尼熊 动物森友会 普习金 包子病毒 裹嘎举吸钢闸门 习兵法 修宪帝 习和谐 刁人13 包包侠 任志强 不敢高声语 习包子的Fa XDD 腊肉馅儿包子 赛禁评 共哀宗 毛近平 无限连任 维尼连任 卡近菲 */
package com.pcdd.sonovel.handle;

import cn.hutool.core.util.StrUtil;
import com.pcdd.sonovel.model.SearchResult;
import lombok.experimental.UtilityClass;

import java.util.*;
import java.util.stream.Collectors;

/**
 * @author pcdd
 * Created at 2025/1/15
 */
@UtilityClass
public class SearchResultsHandler {

    /**
     * 优化某个源站的搜索结果
     */
    public List<SearchResult> sort(List<SearchResult> list) {
        // 按照作者分组
        Map<String, List<SearchResult>> authorGroups = list.stream()
                .collect(Collectors.groupingBy(SearchResult::getAuthor, LinkedHashMap::new, Collectors.toList()));

        // 对每个组进行排序
        return authorGroups.values().stream()
                // 根据每个作者对应的书籍数量进行降序排序
                .sorted((entry1, entry2) -> Integer.compare(entry2.size(), entry1.size()))
                // 每个作者的多个作品按书名排序，而只有一个作品的作者则不做排序
                .map(group -> group.size() > 1
                        ? group.stream().sorted(Comparator.comparing(SearchResult::getBookName)).toList()
                        : group)
                .flatMap(Collection::stream)
                .toList();
    }

    /**
     * 优化聚合搜索结果 V2 版本，自动判断搜索类型
     */
    public static List<SearchResult> aggregateSort(List<SearchResult> data, String kw) {
        double bookNameScore = getSimilarity(data, kw, "bookName");
        double authorScore = getSimilarity(data, kw, "author");
        boolean isAuthorSearch = bookNameScore < authorScore;

        return data.stream()
                // 筛选相似度大于 0.3 的记录
                .filter(sr -> StrUtil.similar(kw, isAuthorSearch ? sr.getAuthor() : sr.getBookName()) > 0.3)
                .sorted((o1, o2) -> {
                    double score1 = StrUtil.similar(kw, isAuthorSearch ? o1.getAuthor() : o1.getBookName());
                    double score2 = StrUtil.similar(kw, isAuthorSearch ? o2.getAuthor() : o2.getBookName());

                    if (score1 != score2) {
                        return Double.compare(score2, score1); // 按相似度降序
                    }

                    return isAuthorSearch
                            ? o1.getBookName().compareTo(o2.getBookName()) // 按书名升序
                            : o1.getAuthor().compareTo(o2.getAuthor());  // 按作者升序
                })
                .toList();
    }

    // 计算权重，用于判断关键字是书名还是作者
    private static double getSimilarity(List<SearchResult> data, String kw, String type) {
        boolean isShortQuery = kw.length() <= 4; // 关键词很短，可能是作者
        boolean isLongQuery = kw.length() >= 10; // 关键词很长，可能是书名

        return data.stream().mapToDouble(sr -> {
            String text = "bookName".equals(type) ? sr.getBookName() : sr.getAuthor();
            double similar = StrUtil.similar(kw, text);

            // 短关键词匹配更严格
            if (isShortQuery) {
                if (similar == 1.0) return 12; // 强调完全匹配
                if (similar >= 0.8) return Math.pow(similar, 3) * 8;
                if (similar >= 0.7) return similar * 5;
                return 0; // 低匹配直接归零，避免误判
            }

            // 长关键词匹配更宽松
            if (isLongQuery) {
                if (similar == 1.0) return 10;
                if (similar >= 0.85) return Math.pow(similar, 3) * 8;
                if (similar >= 0.7) return Math.pow(similar, 2) * 5;
                if (similar >= 0.5) return similar * 3;
                return similar * 1.2;
            }

            // 普通匹配规则
            if (similar == 1.0) return 10;
            if (similar >= 0.85) return Math.pow(similar, 3) * 8;
            if (similar >= 0.7) return Math.pow(similar, 2) * 5;
            if (similar >= 0.5) return similar * 3;
            return 0; // 默认情况，低匹配归零
        }).sum();
    }

}