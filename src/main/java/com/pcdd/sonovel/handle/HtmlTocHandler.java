/* 戴口赵 读稿机 习语 Corona##Xi（习病毒） 鞋哥 乳透社##小反旗 共哀宗 家业论 毛魔转世 恐惊天上人 翡翠娘娘 梦回大清 中国的新皇帝 小学博士 百万雄师事件 金科律玉 集近闭 亲自考察 习尔布特 习大郎 洗尽贫 刁人13 秦城监狱 720事件 役民五术 学包率 习公奭 吃赵弹 猪禁评 习是春绿 吸包皮 习犬犬 习三拍 闹得欢 塔西佗陷阱 习家军 小习微信 刁远山 NMSL 刁斤山 劝进 九评 习时代 习包皮 习大乞 习殡法 动森 清华毕业 初二圣君 阿道夫-习 200吨 尼哥 习核心 习总 形式主义防疫 昆明湖涨潮 末代皇帝 野心习 拉清单 喜包皮 御板泽民 裸宽包子劾心 平平 毛近平 不知名氏 习索里尼 习尿瓶 老街 毛装 国王 禁评封号 格萨尔 戏博士 习驴 阳台上的哨兵 “无罩”现身 东方project 北红尾鸲 亲自删评 口罩外交 送礼平 甩锅侠 最后领导人 赵家家仆 儿童习典 习三点 武统时代 大兔 武当七侠的政治斗争 习禁评 修宪帝 大大品牌 清零宗、清零帝 足球外交 通商宽衣 野兽先辈 习近平光辉形象 灰习牛 共哀宗 二百五大帝 “黄袍加身” 刁二婚 毛二习 吸精瓶 九大诉求 狙击手待命 独裁国贼 腊肉馅儿包子 修宪 讨习檄文 习大 习梦撕 武汉委托李克强 习厉王 岿然不动 Criminal##Xi##"Xitler"##Jinping 习二胖 尊蛤讨包 习近砰 冤大头 一天游泳一千米 维尼大帝 法习斯 云视察 祈翠 习条英机 习太孑 满脸喷粪 人民领袖 “登基” 东瘟疫之地统治者暨全境守护者 习匪 无限连任 10号跳跳虎被维尼拉清单 386系统驱动游戏 口罩大会 席近平 习呆呆 普近 粪坑兵法 核平全世界 嘻包皮 爱新觉罗近平 习二坐船 习猪席 习大帝 朝令夕改 号屎洞 习总输记 习病法 蹄防 背书单 没有网络安全就没有国家安全 bingbang帝 每日祈翠 维尼连任 瘟疫降生习近平 习得梁家书卷 习瘟猪 帝皇頌 刁近乎 扛麦帝 习兵法 维尼带货 皇帝亲临忠诚的武汉 electron8964 习##卡##巴##卡 习孢子 親自蒞臨 庆丰废物 “梦回大清” 断崖式下跌 天安门合法继承人 狙击手布阵 瘟疫领主习近平 赵人13 人尽皆知的体育迷 时间控制 糟糕皇帝 你是反贼吗 野兽主席 《生物安全法》 shuu##kinn##pei 十里山路不换肩 64岁 人民领袖 刁近猴 粪坑先生 习Core 终身领导人 墙内人 我是一个足球迷 孙笑川 The##Xi##Factor（习近平因素） 孢 领袖习澡水 包皇 红二代 包惠帝 维持会长 巴拿马文件 维尼熊 腊肉包 截颈平 梁家河 中国首席造梦大师 游泳一千米 疫情蔓延 疯狂宇宙大帝 现任匪首 袁世凯第二 富平学霸刁斤干 字共狗 孤独的毒王 shit侯 惜包皮 红旗下的蛋 习二卒 习尽贫 习低能儿 “复辟” 中国爱非洲 习进棺 包子病毒 蔡英文最强助选 神明论 纳翠党 集金币 第22条军规 Chairman##Xi 疯狂宇宙包 习包子的Fa 支那精神野爹 主席贺词 刁槑夶尛 包禁评 习老八 指定接班人 感恩教育 席子兵法 维尼史 刁斤二 世界最强乞丐 䒒(tiáo)菦(qín)苹(píng) 维尼写史 五毛主席 颐使气指 庆丰称帝 不强自息 黑白翠 中国离岸隐匿资产管理工作领导小组组组长 抗麦套装 禁评的理由 屎禁评 习教父 崇祯 习壳郎 Heil##Xitler 公车上书 专治各种不服 清单帝 维尼熊给跳跳虎黄牌 夶 习匪帝 当皇帝的小丑 包帝巡游 毛进平 哲欣 习屎黄 学包分子 墨索里习 日子像蜜甜 第一书记王沪宁 赵弹 习包子 花花公子 相信有神论的物理学博士 习王的田野上 嬉包皮 十日文革 倒车 捐麦子 皇帝的新衣 毛泽东2.0 外交习语 胡志平 撒币宝 习思想 “皇帝梦” 习二二（二零二零年五月二十二日开二会） “登机”（与登基同音） 颐指气使 20000T麦子 叼斤干 次级乳包 悉包皮 爱新觉罗·近平 隔离”的金葫芦 习达姆 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 习梦思 习歪嘴 刁大犬 习言乱语 virus##king 超邓赶毛 习二世胡亥 重地之战 宽衣大帝 习张三丰 狙击手待命 骑巨龙 老歪脖子树 宰相 总统包子习 习博士 糖尿维尼 主席+终身制 习宽衣 习付 晚共昏君 仲夏夜之中国梦 乳制品 卡近菲 皇帝亲临忠诚的武汉 冠子兵法 习蛤 习习蛤蛤 大国造疫 大海掀翻小池塘 坡涛汹涌 北京中南海支部书记 习包子 习武帝 甴近平 叩谢习恩 玉习大帝 沼气专家 习皇帝 匪酋习维尼 食腐虫 没规划的葬礼 Cicada##3301##XD 智商不重要 屎進瓶 人民战争 任志强 文明其精神 Mr##Shithole 白猪 读书单 xdd shit##hole##bing##fa 青年大学包 影子末帝 包子兵法 黄俄 习奥塞斯库、齐奥塞斯库 SB包子 国贼习近平 習敗敗 习流氓 习king 坟头蹦迪 Voice##of##Pooh 习皇的新装 维尼之声 皇帝梦 基拉大和习近平 包子金刚腿 灭共助推器 平话 半羽习近平 人均接近八千万 大锅瞻遗 习“甩锅” 习像章 不同意的举手##没有##没有 非洲大撒币 袭包皮 习大林 不敢高声语 战疫国 十一郎习近平 坡涛汹涌 当代秦始皇 习澳塞斯库 傻大头 两会期间+隐瞒 维尼·屎(Winnie##the##Poo) 亲自脱贫 川普的朋友or敌人 习猪下台 shit禁评 习梦死 细瓶颈 习夶 野蛮其体魄 新影帝 这个年很静 宽衣帝 习一尊 包经 万岁 屎侯 做N届的主席 民进党 信女愿一生吃素 习奥塞斯库 戏包皮 刁人13 世宗 支那毒王 XDD 总书记来过我的家 4中组长 号尿壶公 中国特色射秽煮疫制度 迈克尔·索伊 V尼哥 裹嘎举吸钢闸门 太祖兔 親自視頻 官僚主义 动物庄园 连专家也为之叹服的电脑天才 习奥赛斯库 总加速师 梁家河贵族 普习金 刁二将 近言 WHO的君王 任大炮 習大佬 毛孙 小学居士 战“疫”金句 毛二世 习emperor 央视姓党 羽日帝 贬词包用 习狍 萨格尔王 万岁来武汉 二百斤 总书记来我家 习卒习 梦帝 Adolf##Xitler 习贼 中国拉清单工作领导小组组长 西朝鲜人民自治岛 ChinaXi 洗包皮 恩重如删 那翠化 学包积极分子 头号球迷 习和谐 维尼DISCO 彩色哥 刁后主 大撒幣 独彩者 祈翠語言包 习正日 视频看望 维尼快乐组织（Winnie##Happy##Organization）简称WHO 扛麦郎 维尼梗有害 万岁来武汉了 习是春竹 疯狂宇宙 倒车斯基 阿平 称帝修宪 当代秦二世 习侯 倒车帝 冰棒外交 厕所革命 包包大人 习包子 赵付 庆丰包·勃列日涅夫 包包侠 乳包文化 赛禁评 包子宪法 中字头组长 包子露宪 冲塔 亲自指挥 电脑世代586 习曱甴 中国离岸隐匿资产管理工作领导小组组组长 退党 维稳警察（O） 习背书 细颈瓶 习大犬 習敗北 习特勒 独裁者 A##Big##Deal 人类命运共同体首席架构师 习躲躲 亲自指挥疫情 赵王 假.."~bang！卒 甴种 头上三尺有神明 恩维尔·霍习 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 平&强 彭主席（习主席走了太太接班） 集金pay 维尼警察（X） 习卒 亲自封号 nmslman（习主席） 习猪头 大大招牌 一带一路 近身平A 法外狂徒Lucy（德国） 习后主 发皇帝梦 动物之森 庆丰帝的千秋梦 习语录 維尼頌 习二蛋 近日成 习式病毒 氼兲嫑炛 耀眼黄红黄 邪大大 “习泽东”和“洪宪”（袁世凯的帝号） 2020全面小康 添宪宝宝 崇祯帝 彩色熊 二次袁、袁世凯二世、袁二 修宪连任 习下台 叩谢习恩 nmslese##dream 追思焦裕禄 CoronaXi 大撒币 禁评大帝 习废帝 毛二 vop 包大人 维尼挂彩 系包皮 枪毙名单 韦来书记 XD 书单吟诵者 通商宽衣 动物森友会 慨撒大帝 习远凸 错误执行者 喷粪帝 */
package com.pcdd.sonovel.handle;

import cn.hutool.core.io.FileUtil;
import cn.hutool.core.io.file.FileReader;
import cn.hutool.core.io.file.FileWriter;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.ReUtil;
import cn.hutool.core.util.StrUtil;
import cn.hutool.http.HttpUtil;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.util.FileUtils;

import java.io.File;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;

/**
 * @author pcdd
 * Created at 2024/12/4
 */
public class HtmlTocHandler implements PostProcessingHandler {

    @Override
    public void handle(Book book, File savePath) {
        List<String> strings = new ArrayList<>();
        String regex = "<title>(.*?)</title>";

        strings.add("文件名\t\t章节名");
        List<File> files = FileUtils.sortFilesByName(savePath);
        int i = Integer.parseInt(StrUtil.subBefore(files.get(0).getName(), "_", false));
        for (File file : files) {
            FileReader fr = FileReader.create(file, StandardCharsets.UTF_8);
            // 获取 <title> 内容
            String title = ReUtil.getGroup1(regex, fr.readString());
            strings.add(StrUtil.format("{}_.html\t\t{}", i++, title));
        }

        File file = FileUtil.touch(savePath + File.separator, "0_目录.txt");
        FileWriter fw = FileWriter.create(file, StandardCharsets.UTF_8);
        fw.writeLines(strings);

        Console.log("<== 正在下载封面：{}", book.getCoverUrl());
        File coverFile = HttpUtil.downloadFileFromUrl(book.getCoverUrl(), System.getProperty("user.dir") + File.separator + savePath);
        FileUtil.rename(coverFile, "0_封面." + FileUtil.getType(coverFile), true);
    }

}