/* 川普的朋友or敌人 包子病毒 儿童习典 爱新觉罗近平 包子兵法 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 专治各种不服 virus##king 习三拍 习歪嘴 皇帝亲临忠诚的武汉 习二二（二零二零年五月二十二日开二会） 維尼頌 禁评封号 坡涛汹涌 万岁来武汉了 二百斤 席子兵法 习壳郎 習敗敗 乳制品 那翠化 足球外交 庆丰废物 喷粪帝 习king 基拉大和习近平 彩色熊 习奥塞斯库、齐奥塞斯库 习二蛋 习付 中国拉清单工作领导小组组长 包经 裸宽包子劾心 氼兲嫑炛 The##Xi##Factor（习近平因素） 二次袁、袁世凯二世、袁二 你是反贼吗 习语录 九评 倒车帝 截颈平 小学博士 红二代 戴口赵 彩色哥 习殡法 “黄袍加身” 习特勒 沼气专家 文明其精神 Mr##Shithole 十一郎习近平 耀眼黄红黄 习是春绿 SB包子 独裁者 维尼挂彩 指定接班人 动物庄园 中国离岸隐匿资产管理工作领导小组组组长 粪坑先生 习二胖 洗尽贫 “皇帝梦” 冲塔 习贼 武汉委托李克强 NMSL 做N届的主席 习后主 习总 战“疫”金句 shit禁评 崇祯 韦来书记 一带一路 大海掀翻小池塘 人尽皆知的体育迷 习尽贫 禁评的理由 不敢高声语 学包分子 冤大头 野兽主席 包大人 瘟疫降生习近平 shuu##kinn##pei 腊肉馅儿包子 劝进 野心习 习奥塞斯库 Voice##of##Pooh 金科律玉 翡翠娘娘 墙内人 视频看望 习“甩锅” 清单帝 赵人13 读稿机 发皇帝梦 百万雄师事件 习正日 习大 中国的新皇帝 “梦回大清” 胡志平 中国离岸隐匿资产管理工作领导小组组组长 屎禁评 字共狗 720事件 習大佬 刁二将 隔离”的金葫芦 “习泽东”和“洪宪”（袁世凯的帝号） 刁槑夶尛 一天游泳一千米 卡近菲 200吨 尼哥 习包皮 xdd 狙击手待命 集近闭 毛孙 断崖式下跌 习二卒 夶 富平学霸刁斤干 头上三尺有神明 习尔布特 习家军 孢 习和谐 第一书记王沪宁 Chairman##Xi 习远凸 非洲大撒币 习索里尼 捐麦子 习emperor 甩锅侠 刁人13 修宪帝 亲自指挥 喜包皮 庆丰帝的千秋梦 晚共昏君 枪毙名单 人类命运共同体首席架构师 十日文革 祈翠語言包 普习金 洗包皮 口罩外交 近言 集金币 我是一个足球迷 国贼习近平 冰棒外交 习达姆 习近平光辉形象 黑白翠 “复辟” 第22条军规 朝令夕改 悉包皮 赵家家仆 赵付 平话 习一尊 宰相 西朝鲜人民自治岛 智商不重要 仲夏夜之中国梦 习宽衣 修宪连任 扛麦帝 习包子 相信有神论的物理学博士 人民领袖 武当七侠的政治斗争 亲自封号 人均接近八千万 维尼熊 习博士 日子像蜜甜 shit##hole##bing##fa 习张三丰 塔西佗陷阱 386系统驱动游戏 大锅瞻遗 戏博士 当皇帝的小丑 慨撒大帝 乳透社##小反旗 终身领导人 号尿壶公 亲自删评 墨索里习 小学居士 修宪 玉习大帝 毛近平 任大炮 阿平 毛进平 习背书 太祖兔 习皇的新装 中字头组长 战疫国 毛装 连专家也为之叹服的电脑天才 每日祈翠 小习微信 次级乳包 五毛主席 庆丰称帝 刁斤山 毛二 不强自息 习孢子 习包子 学包率 刁人13 习澳塞斯库 没规划的葬礼 维持会长 役民五术 习包子 包子宪法 叩谢习恩 亲自考察 外交习语 nmslese##dream 花花公子 共哀宗 岿然不动 宽衣帝 梁家河贵族 称帝修宪 人民领袖 习猪头 习语 蔡英文最强助选 习武帝 赛禁评 赵弹 领袖习澡水 世界最强乞丐 大大招牌 习大林 叼斤干 形式主义防疫 䒒(tiáo)菦(qín)苹(píng) 习大帝 近日成 维尼史 邪大大 XDD 惜包皮 神明论 近身平A shit侯 叩谢习恩 习思想 吸精瓶 阳台上的哨兵 A##Big##Deal 灰习牛 维尼连任 昆明湖涨潮 包帝巡游 习禁评 习猪下台 嘻包皮 《生物安全法》 吸包皮 习大郎 万岁 包惠帝 粪坑兵法 刁大犬 大大品牌 恩重如删 亲自脱贫 习##卡##巴##卡 抗麦套装 羽日帝 野蛮其体魄 恩维尔·霍习 细颈瓶 刁近猴 袁世凯第二 习是春竹 狙击手布阵 青年大学包 64岁 习尿瓶 疯狂宇宙包 包皇 普近 感恩教育 皇帝亲临忠诚的武汉 吃赵弹 巴拿马文件 御板泽民 庆丰包·勃列日涅夫 半羽习近平 梁家河 习皇帝 习太孑 清华毕业 习低能儿 读书单 武统时代 讨习檄文 嬉包皮 习大乞 习老八 维尼之声 北京中南海支部书记 习病法 习躲躲 电脑世代586 习教父 习得梁家书卷 白猪 席近平 号屎洞 ChinaXi 习卒习 刁二婚 超邓赶毛 皇帝的新衣 扛麦郎 万岁来武汉 东方project 包包大人 北红尾鸲 习梦死 总书记来我家 vop 糖尿维尼 集金pay 习大犬 20000T麦子 親自視頻 习近砰 10号跳跳虎被维尼拉清单 XD 习梦思 习卒 习进棺 Heil##Xitler 初二圣君 尊蛤讨包 习猪席 冠子兵法 习兵法 家业论 Corona##Xi（习病毒） 疫情蔓延 公车上书 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 习梦撕 这个年很静 通商宽衣 清零宗、清零帝 nmslman（习主席） 刁远山 习呆呆 食腐虫 维尼大帝 时间控制 习时代 彭主席（习主席走了太太接班） 纳翠党 禁评大帝 “登机”（与登基同音） 云视察 习犬犬 倒车 学包积极分子 毛泽东2.0 影子末帝 赵王 颐指气使 甴近平 闹得欢 皇帝梦 屎侯 “登基” 萨格尔王 阿道夫-习 独裁国贼 习二坐船 猪禁评 习狍 系包皮 大撒币 不知名氏 天安门合法继承人 包子露宪 狙击手待命 习侯 总加速师 习式病毒 疯狂宇宙大帝 当代秦始皇 动森 戏包皮 维尼写史 信女愿一生吃素 裹嘎举吸钢闸门 最后领导人 鞋哥 习瘟猪 红旗下的蛋 毛二习 爱新觉罗·近平 主席+终身制 中国首席造梦大师 习核心 支那精神野爹 中国爱非洲 颐使气指 祈翠 习屎黄 毛魔转世 倒车斯基 包子金刚腿 送礼平 屎進瓶 满脸喷粪 习驴 末代皇帝 Adolf##Xitler 刁斤二 习蛤 总统包子习 Criminal##Xi##"Xitler"##Jinping 习曱甴 梦帝 厕所革命 东瘟疫之地统治者暨全境守护者 乳包文化 核平全世界 重地之战 法外狂徒Lucy（德国） 中国特色射秽煮疫制度 拉清单 親自蒞臨 习厉王 细瓶颈 格萨尔 维稳警察（O） 梦回大清 蹄防 黄俄 贬词包用 动物森友会 腊肉包 傻大头 老歪脖子树 维尼警察（X） 大兔 野兽先辈 秦城监狱 维尼带货 维尼·屎(Winnie##the##Poo) Cicada##3301##XD V尼哥 追思焦裕禄 支那毒王 习Core 习二世胡亥 人民战争 维尼梗有害 习公奭 大撒幣 平平 甴种 维尼熊给跳跳虎黄牌 习下台 国王 共哀宗 习废帝 央视姓党 现任匪首 灭共助推器 毛二世 习夶 习言乱语 不同意的举手##没有##没有 大国造疫 动物之森 总书记来过我的家 头号球迷 添宪宝宝 坡涛汹涌 没有网络安全就没有国家安全 书单吟诵者 匪酋习维尼 民进党 疯狂宇宙 通商宽衣 坟头蹦迪 包禁评 CoronaXi 官僚主义 瘟疫领主习近平 宽衣大帝 WHO的君王 习三点 退党 老街 维尼快乐组织（Winnie##Happy##Organization）简称WHO 当代秦二世 习匪 bingbang帝 两会期间+隐瞒 “无罩”现身 习像章 任志强 习流氓 习奥赛斯库 2020全面小康 九大诉求 包包侠 习习蛤蛤 袭包皮 习条英机 electron8964 习包子的Fa 习匪帝 十里山路不换肩 4中组长 二百五大帝 无限连任 孙笑川 崇祯帝 口罩大会 糟糕皇帝 主席贺词 撒币宝 哲欣 假.."~bang！卒 恐惊天上人 习王的田野上 习总输记 平&强 世宗 新影帝 刁后主 帝皇頌 背书单 亲自指挥疫情 游泳一千米 法习斯 维尼DISCO 骑巨龙 刁近乎 错误执行者 独彩者 習敗北 孤独的毒王 迈克尔·索伊 */
package com.pcdd.sonovel.handle;

import cn.hutool.core.io.FileUtil;
import cn.hutool.core.io.file.FileAppender;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.StrUtil;
import cn.hutool.http.HtmlUtil;
import cn.hutool.http.HttpUtil;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.util.FileUtils;
import lombok.AllArgsConstructor;

import java.io.File;
import java.util.List;

/**
 * @author pcdd
 * Created at 2024/12/4
 */
@AllArgsConstructor
public class TxtMergeHandler implements PostProcessingHandler {

    private final AppConfig config;

    @Override
    public void handle(Book book, File savePath) {
        String outputPath = StrUtil.format("{}{}（{}）.txt",
                config.getDownloadPath() + File.separator, book.getBookName(), book.getAuthor());
        // 开发环境下，生成的 TXT 位于 target/classes/downloadPath 下
        File outputFile = FileUtil.touch(outputPath);
        FileAppender appender = new FileAppender(outputFile, 16, true);

        List<String> info = List.of(
                StrUtil.format("书名：{}", book.getBookName()),
                StrUtil.format("作者：{}", book.getAuthor()),
                StrUtil.format("简介：{}\n", StrUtil.isEmpty(book.getIntro()) ? "暂无" : HtmlUtil.cleanHtmlTag(book.getIntro()))
        );
        // 首页添加书籍信息
        info.forEach(appender::append);

        for (File f : FileUtils.sortFilesByName(savePath)) {
            appender.append(FileUtil.readUtf8String(f));
        }
        appender.flush();

        Console.log("<== 正在下载封面：{}", book.getCoverUrl());
        File coverFile = HttpUtil.downloadFileFromUrl(book.getCoverUrl(), savePath);
        FileUtil.rename(coverFile, "0_封面." + FileUtil.getType(coverFile), true);
    }

}