/* 重地之战 毛泽东2.0 官僚主义 习卒习 习付 亲自指挥 习是春绿 次级乳包 NMSL 中国特色射秽煮疫制度 西朝鲜人民自治岛 信女愿一生吃素 习后主 叩谢习恩 毛二 习进棺 墙内人 近身平A 皇帝亲临忠诚的武汉 裹嘎举吸钢闸门 武统时代 送礼平 通商宽衣 习猪头 支那毒王 号屎洞 主席+终身制 刁远山 背书单 鞋哥 XD “无罩”现身 贬词包用 袭包皮 毛进平 庆丰称帝 席近平 中国离岸隐匿资产管理工作领导小组组组长 习包子 视频看望 墨索里习 维尼熊 十一郎习近平 刁人13 Corona##Xi（习病毒） 习大郎 Adolf##Xitler 系包皮 朝令夕改 习得梁家书卷 习病法 刁槑夶尛 习厉王 武当七侠的政治斗争 叩谢习恩 清零宗、清零帝 清华毕业 “习泽东”和“洪宪”（袁世凯的帝号） 家业论 国贼习近平 包子病毒 老歪脖子树 习二世胡亥 习犬犬 新影帝 帝皇頌 包帝巡游 人民领袖 毛装 形式主义防疫 维持会长 “登基” 法习斯 习皇的新装 任志强 氼兲嫑炛 不强自息 坟头蹦迪 粪坑兵法 习核心 大锅瞻遗 东方project 包子金刚腿 维尼带货 nmslese##dream 当代秦二世 720事件 冰棒外交 习驴 习尔布特 CoronaXi Cicada##3301##XD 颐使气指 shuu##kinn##pei 习近平光辉形象 嬉包皮 习大犬 庆丰废物 习emperor 屎侯 64岁 北京中南海支部书记 习猪席 彭主席（习主席走了太太接班） 习二坐船 红旗下的蛋 你是反贼吗 习包子的Fa 动物森友会 大兔 习达姆 习公奭 糖尿维尼 狙击手待命 20000T麦子 细颈瓶 梁家河贵族 《生物安全法》 十日文革 包惠帝 沼气专家 二百斤 习三拍 彩色哥 Heil##Xitler 战疫国 乳制品 倒车帝 维尼挂彩 阳台上的哨兵 拉清单 世宗 彩色熊 习卒 10号跳跳虎被维尼拉清单 腊肉馅儿包子 习奥赛斯库 近言 爱新觉罗·近平 太祖兔 Voice##of##Pooh 末代皇帝 习博士 秦城监狱 尊蛤讨包 蹄防 没规划的葬礼 厕所革命 宽衣帝 相信有神论的物理学博士 親自蒞臨 半羽习近平 毛近平 读稿机 中国拉清单工作领导小组组长 习下台 晚共昏君 匪酋习维尼 人尽皆知的体育迷 口罩外交 通商宽衣 习“甩锅” 屎進瓶 习大 吃赵弹 不敢高声语 习奥塞斯库 枪毙名单 战“疫”金句 皇帝的新衣 shit##hole##bing##fa 九大诉求 邪大大 最后领导人 扛麦帝 甴种 我是一个足球迷 习king 维尼快乐组织（Winnie##Happy##Organization）简称WHO 䒒(tiáo)菦(qín)苹(píng) 习梦思 平平 普近 阿道夫-习 习澳塞斯库 普习金 包皇 崇祯 戏包皮 刁斤山 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 游泳一千米 冤大头 食腐虫 习索里尼 坡涛汹涌 集金pay 裸宽包子劾心 动森 习流氓 十里山路不换肩 包子宪法 错误执行者 包大人 习奥塞斯库、齐奥塞斯库 习二蛋 细瓶颈 习宽衣 专治各种不服 惜包皮 字共狗 习语录 青年大学包 无限连任 仲夏夜之中国梦 支那精神野爹 习猪下台 嘻包皮 倒车 百万雄师事件 疯狂宇宙大帝 巴拿马文件 当皇帝的小丑 花花公子 民进党 连专家也为之叹服的电脑天才 瘟疫领主习近平 386系统驱动游戏 洗包皮 集近闭 习教父 役民五术 親自視頻 宰相 习兵法 戴口赵 满脸喷粪 万岁来武汉 大撒幣 领袖习澡水 nmslman（习主席） 习老八 爱新觉罗近平 颐指气使 慨撒大帝 疫情蔓延 习像章 中国的新皇帝 electron8964 宽衣大帝 御板泽民 xdd 维尼写史 维尼熊给跳跳虎黄牌 4中组长 维尼连任 毛魔转世 习背书 昆明湖涨潮 Chairman##Xi 不知名氏 “黄袍加身” 白猪 扛麦郎 vop 习总输记 文明其精神 大国造疫 崇祯帝 人类命运共同体首席架构师 习孢子 梁家河 戏博士 习屎黄 非洲大撒币 习梦死 习低能儿 蔡英文最强助选 习蛤 习家军 一带一路 赛禁评 不同意的举手##没有##没有 shit侯 禁评封号 习殡法 200吨 五毛主席 日子像蜜甜 中字头组长 恐惊天上人 总书记来我家 头上三尺有神明 WHO的君王 终身领导人 刁大犬 习习蛤蛤 腊肉包 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ SB包子 维稳警察（O） 倒车斯基 习包皮 万岁来武汉了 习语 包经 法外狂徒Lucy（德国） 祈翠 北红尾鸲 羽日帝 习特勒 禁评的理由 大撒币 孤独的毒王 习近砰 习太孑 包禁评 亲自脱贫 庆丰帝的千秋梦 习总 抗麦套装 毛孙 亲自删评 添宪宝宝 習敗敗 断崖式下跌 习Core 包包侠 天安门合法继承人 灰习牛 孙笑川 习大乞 央视姓党 动物庄园 习三点 这个年很静 刁人13 ChinaXi 截颈平 习一尊 乳透社##小反旗 玉习大帝 每日祈翠 习条英机 胡志平 共哀宗 足球外交 刁后主 包包大人 习二卒 习曱甴 bingbang帝 动物之森 总加速师 耀眼黄红黄 时间控制 屎禁评 习王的田野上 神明论 闹得欢 翡翠娘娘 口罩大会 捐麦子 川普的朋友or敌人 糟糕皇帝 瘟疫降生习近平 影子末帝 电脑世代586 九评 大大招牌 维尼史 禁评大帝 讨习檄文 维尼警察（X） 皇帝亲临忠诚的武汉 中国首席造梦大师 独裁者 人均接近八千万 近日成 Criminal##Xi##"Xitler"##Jinping 習大佬 习壳郎 小学博士 号尿壶公 毛二世 坡涛汹涌 习歪嘴 大海掀翻小池塘 赵付 洗尽贫 习思想 叼斤干 庆丰包·勃列日涅夫 没有网络安全就没有国家安全 总书记来过我的家 撒币宝 A##Big##Deal 萨格尔王 独彩者 东瘟疫之地统治者暨全境守护者 赵王 維尼頌 梦回大清 “梦回大清” 猪禁评 野蛮其体魄 人民战争 冠子兵法 “皇帝梦” 狙击手待命 2020全面小康 初二圣君 发皇帝梦 刁二婚 习是春竹 修宪帝 习废帝 维尼大帝 修宪连任 习皇帝 书单吟诵者 二次袁、袁世凯二世、袁二 梦帝 傻大头 毛二习 Mr##Shithole 习时代 那翠化 第22条军规 儿童习典 恩重如删 大大品牌 黑白翠 维尼·屎(Winnie##the##Poo) 世界最强乞丐 黄俄 习贼 感恩教育 乳包文化 两会期间+隐瞒 清单帝 隔离”的金葫芦 习张三丰 迈克尔·索伊 习瘟猪 哲欣 赵弹 习二胖 现任匪首 狙击手布阵 习尽贫 维尼梗有害 红二代 平话 智商不重要 刁近乎 做N届的主席 金科律玉 集金币 格萨尔 习##卡##巴##卡 公车上书 亲自指挥疫情 shit禁评 追思焦裕禄 称帝修宪 指定接班人 野兽先辈 夶 中国离岸隐匿资产管理工作领导小组组组长 赵家家仆 悉包皮 韦来书记 野兽主席 平&强 席子兵法 virus##king 任大炮 祈翠語言包 基拉大和习近平 主席贺词 岿然不动 读书单 包子兵法 纳翠党 孢 习和谐 云视察 核平全世界 喜包皮 亲自考察 一天游泳一千米 学包积极分子 刁斤二 共哀宗 疯狂宇宙包 习大帝 国王 習敗北 修宪 The##Xi##Factor（习近平因素） 假.."~bang！卒 习式病毒 粪坑先生 吸精瓶 习匪 习武帝 人民领袖 习正日 包子露宪 习尿瓶 习匪帝 老街 刁近猴 习包子 习呆呆 小习微信 习包子 退党 “登机”（与登基同音） 习梦撕 冲塔 头号球迷 习二二（二零二零年五月二十二日开二会） 富平学霸刁斤干 中国爱非洲 独裁国贼 劝进 刁二将 二百五大帝 喷粪帝 武汉委托李克强 习禁评 习狍 维尼之声 灭共助推器 万岁 维尼DISCO 总统包子习 甴近平 尼哥 亲自封号 塔西佗陷阱 学包分子 习侯 吸包皮 V尼哥 学包率 骑巨龙 卡近菲 习言乱语 第一书记王沪宁 XDD 习夶 外交习语 野心习 当代秦始皇 赵人13 疯狂宇宙 习大林 习远凸 超邓赶毛 皇帝梦 “复辟” 袁世凯第二 小学居士 恩维尔·霍习 习躲躲 阿平 甩锅侠 */
package com.pcdd.sonovel.handle;

import cn.hutool.core.io.FileUtil;
import cn.hutool.core.io.resource.ResourceUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.StrUtil;
import cn.hutool.http.HttpUtil;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.util.FileUtils;
import io.documentnode.epub4j.domain.*;
import io.documentnode.epub4j.epub.EpubWriter;
import lombok.SneakyThrows;

import java.io.File;
import java.io.FileOutputStream;
import java.util.Date;
import java.util.List;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2024/12/4
 */
public class EpubMergeHandler implements PostProcessingHandler {

    public static final String COVER_NAME = "cover.html";

    @SneakyThrows
    @Override
    public void handle(Book b, File savePath) {
        if (FileUtil.isDirEmpty(savePath)) {
            Console.error(render("==> 《{}》（{}）下载章节数为 0，取消生成 EPUB", "red"), b.getBookName(), b.getAuthor());
            return;
        }

        io.documentnode.epub4j.domain.Book book = new io.documentnode.epub4j.domain.Book();
        // content.opf > metadata
        Metadata meta = book.getMetadata();
        meta.addTitle(b.getBookName());
        meta.setAuthors(List.of(new Author(b.getAuthor())));
        meta.addDescription(b.getIntro());
        // 下载封面失败会导致生成 epub 中断
        try {
            Console.log("<== 正在下载封面：{}", b.getCoverUrl());
            byte[] bytes = HttpUtil.downloadBytes(b.getCoverUrl());
            book.setCoverImage(new Resource(bytes, "cover.jpg"));
        } catch (Exception e) {
            Console.error(render("封面下载失败：{}", "red"), e.getMessage());
        }
        // 不设置会导致 Apple Books 无法使用苹方字体
        meta.setLanguage("zh");
        meta.setDates(List.of(new io.documentnode.epub4j.domain.Date(new Date())));
        meta.addPublisher("so-novel");
        meta.setRights(List.of("本电子书由 so-novel(https://github.com/freeok/so-novel) 制作生成。仅供交流使用，不得用于商业用途。"));

        // content.opf > manifest
        List<File> files = FileUtils.sortFilesByName(savePath);
        int len = String.valueOf(files.size()).length();
        // 添加封面页
        book.addSection("封面", new Resource(ResourceUtil.readBytes("templates/chapter_cover.html"), COVER_NAME));
        // 添加正文页
        for (int i = 0; i < files.size(); i++) {
            File file = files.get(i);
            // 截取第一个 _ 后的字符串，即章节名
            String title = StrUtil.subAfter(FileUtil.mainName(file), "_", false);
            String id = StrUtil.padPre(String.valueOf(i + 1), len, '0');
            book.addSection(title, new Resource(id, FileUtil.readBytes(file), id + ".html", MediaTypes.XHTML));
        }

        // 设置 guide，用于指定封面
        book.getGuide().addReference(new GuideReference(new Resource(ResourceUtil.readBytes("templates/chapter_cover.html"), COVER_NAME), "封面", COVER_NAME));
        EpubWriter epubWriter = new EpubWriter();
        epubWriter.write(book, new FileOutputStream(StrUtil.format("{}/{}.epub", savePath.getParent(), b.getBookName())));
        FileUtil.del(savePath);
    }

}